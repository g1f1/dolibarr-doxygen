<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dolibarr: htdocs/core/modules/import/import_xlsx.modules.php Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../dolibarr.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Dolibarr
   &#160;<span id="projectnumber">develop</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('da/d93/import__xlsx_8modules_8php_source.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">import_xlsx.modules.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../da/d93/import__xlsx_8modules_8php.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;?php</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">/* Copyright (C) 2006-2012  Laurent Destailleur &lt;eldy@users.sourceforge.net&gt;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * Copyright (C) 2009-2012  Regis Houssin       &lt;regis.houssin@inodbox.com&gt;</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * Copyright (C) 2012      Christophe Battarel  &lt;christophe.battarel@altairis.fr&gt;</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * Copyright (C) 2012-2016 Juanjo Menent        &lt;jmenent@2byte.es&gt;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * This program is free software; you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * the Free Software Foundation; either version 3 of the License, or</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * (at your option) any later version.</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * GNU General Public License for more details.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * You should have received a copy of the GNU General Public License</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * along with this program. If not, see &lt;https://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * or see https://www.gnu.org/</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160; </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;use PhpOffice\PhpSpreadsheet\Reader\Xlsx;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;use PhpOffice\PhpSpreadsheet\Spreadsheet;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;use PhpOffice\PhpSpreadsheet\Style\Alignment;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160; </div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;require_once DOL_DOCUMENT_ROOT . <span class="stringliteral">&#39;/core/modules/import/modules_import.php&#39;</span>;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160; </div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160; </div>
<div class="line"><a name="l00038"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html">   38</a></span>&#160;<span class="keyword">class </span><a class="code" href="../../d4/d28/class_import_xlsx.html">ImportXlsx</a> <span class="keyword">extends</span> <a class="code" href="../../d9/d99/class_modele_imports.html">ModeleImports</a></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="keyword">public</span> $db;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160; </div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keyword">public</span> $datatoimport;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160; </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keyword">public</span> $error = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keyword">public</span> $errors = array();</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160; </div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keyword">public</span> $id;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keyword">public</span> $label;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; </div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keyword">public</span> $extension; <span class="comment">// Extension of files imported by driver</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160; </div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keyword">public</span> $version = <span class="stringliteral">&#39;dolibarr&#39;</span>;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keyword">public</span> $label_lib; <span class="comment">// Label of external lib used by driver</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keyword">public</span> $version_lib; <span class="comment">// Version of external lib used by driver</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160; </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keyword">public</span> $separator;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160; </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keyword">public</span> $file; <span class="comment">// Path of file</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160; </div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keyword">public</span> $handle; <span class="comment">// Handle fichier</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160; </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="keyword">public</span> $cacheconvert = array(); <span class="comment">// Array to cache list of value found after a convertion</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160; </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keyword">public</span> $cachefieldtable = array(); <span class="comment">// Array to cache list of value found into fields@tables</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160; </div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keyword">public</span> $workbook; <span class="comment">// temporary import file</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160; </div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="keyword">public</span> $record; <span class="comment">// current record</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160; </div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="keyword">public</span> $headers;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160; </div>
<div class="line"><a name="l00102"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#a2e845a1f0eb266b4b390e49d4226a9d5">  102</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#a2e845a1f0eb266b4b390e49d4226a9d5">__construct</a>($db, $datatoimport)</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    {</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        global $conf, $langs;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a> = $db;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="comment">// this is used as an extension from the example file code, so we have to put xlsx here !!!</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        $this-&gt;<span class="keywordtype">id</span> = <span class="stringliteral">&#39;xlsx&#39;</span>; <span class="comment">// Same value as xxx in file name export_xxx.modules.php</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        $this-&gt;label = <span class="stringliteral">&#39;Excel 2007&#39;</span>; <span class="comment">// Label of driver</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        $this-&gt;desc = $langs-&gt;trans(<span class="stringliteral">&quot;Excel2007FormatDesc&quot;</span>);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        $this-&gt;extension = <span class="stringliteral">&#39;xlsx&#39;</span>; <span class="comment">// Extension for generated file by this driver</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        $this-&gt;picto = <span class="stringliteral">&#39;mime/xls&#39;</span>; <span class="comment">// Picto (This is not used by the example file code as Mime type, too bad ...)</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        $this-&gt;version = <span class="stringliteral">&#39;1.0&#39;</span>; <span class="comment">// Driver version</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <span class="comment">// If driver use an external library, put its name here</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/includes/phpoffice/phpspreadsheet/src/autoloader.php&#39;</span>;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/includes/Psr/autoloader.php&#39;</span>;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        require_once PHPEXCELNEW_PATH.<span class="stringliteral">&#39;Spreadsheet.php&#39;</span>;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        $this-&gt;workbook = <span class="keyword">new</span> Spreadsheet();</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160; </div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="comment">//if ($this-&gt;id == &#39;excel2007new&#39;)</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        {</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="keywordflow">if</span> (!class_exists(<span class="stringliteral">&#39;ZipArchive&#39;</span>)) {  <span class="comment">// For Excel2007</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            $langs-&gt;load(<span class="stringliteral">&quot;errors&quot;</span>);</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            $this-&gt;error = $langs-&gt;trans(<span class="stringliteral">&#39;ErrorPHPNeedModule&#39;</span>, <span class="stringliteral">&#39;zip&#39;</span>);</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        }</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        }</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        $this-&gt;label_lib = <span class="stringliteral">&#39;PhpSpreadSheet&#39;</span>;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        $this-&gt;version_lib = <span class="stringliteral">&#39;1.8.0&#39;</span>;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160; </div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        $this-&gt;datatoimport = $datatoimport;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^societe_/&#39;</span>, $datatoimport)) {</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            $this-&gt;thirpartyobject = <span class="keyword">new</span> <a class="code" href="../../dc/dbc/class_societe.html">Societe</a>($this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        }</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    }</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160; </div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160; </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00145"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#aca89d7487686082c2eba4597877843f1">  145</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#aca89d7487686082c2eba4597877843f1">write_header_example</a>($outputlangs)</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    {</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        global $user, $conf, $langs, $file;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="comment">// create a temporary object, the final output will be generated in footer</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        $this-&gt;workbook-&gt;getProperties()-&gt;setCreator($user-&gt;getFullName($outputlangs) . <span class="stringliteral">&#39; - Dolibarr &#39;</span> . DOL_VERSION);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        $this-&gt;workbook-&gt;getProperties()-&gt;setTitle($outputlangs-&gt;trans(<span class="stringliteral">&quot;Import&quot;</span>) . <span class="stringliteral">&#39; - &#39;</span> . $file);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        $this-&gt;workbook-&gt;getProperties()-&gt;setSubject($outputlangs-&gt;trans(<span class="stringliteral">&quot;Import&quot;</span>) . <span class="stringliteral">&#39; - &#39;</span> . $file);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        $this-&gt;workbook-&gt;getProperties()-&gt;setDescription($outputlangs-&gt;trans(<span class="stringliteral">&quot;Import&quot;</span>) . <span class="stringliteral">&#39; - &#39;</span> . $file);</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160; </div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        $this-&gt;workbook-&gt;setActiveSheetIndex(0);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        $this-&gt;workbook-&gt;getActiveSheet()-&gt;setTitle($outputlangs-&gt;trans(<span class="stringliteral">&quot;Sheet&quot;</span>));</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        $this-&gt;workbook-&gt;getActiveSheet()-&gt;getDefaultRowDimension()-&gt;setRowHeight(16);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160; </div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    }</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160; </div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00170"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#a32e1fa6a90c6a4f81959e3cb50ee9ea2">  170</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#a32e1fa6a90c6a4f81959e3cb50ee9ea2">write_title_example</a>($outputlangs, $headerlinefields)</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    {</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        global $conf;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        $this-&gt;workbook-&gt;getActiveSheet()-&gt;getStyle(<span class="charliteral">&#39;1&#39;</span>)-&gt;getFont()-&gt;setBold(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        $this-&gt;workbook-&gt;getActiveSheet()-&gt;getStyle(<span class="charliteral">&#39;1&#39;</span>)-&gt;getAlignment()-&gt;setHorizontal(Alignment::HORIZONTAL_LEFT);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160; </div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        $col = 1;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="keywordflow">foreach</span> ($headerlinefields as $field) {</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            $this-&gt;workbook-&gt;getActiveSheet()-&gt;SetCellValueByColumnAndRow($col, 1, $outputlangs-&gt;transnoentities($field));</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            <span class="comment">// set autowidth</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="comment">//$this-&gt;workbook-&gt;getActiveSheet()-&gt;getColumnDimension($this-&gt;column2Letter($col + 1))-&gt;setAutoSize(true);</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;            $col++;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        }</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// final output will be generated in footer</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    }</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160; </div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00196"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#a04e1485cc81c5df79a3a1a3608e515a6">  196</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#a04e1485cc81c5df79a3a1a3608e515a6">write_record_example</a>($outputlangs, $contentlinevalues)</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    {</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        $col = 1;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        $row = 2;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <span class="keywordflow">foreach</span> ($contentlinevalues as $cell) {</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            $this-&gt;workbook-&gt;getActiveSheet()-&gt;SetCellValueByColumnAndRow($col, $row, $cell);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            $col++;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        }</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160; </div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// final output will be generated in footer</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    }</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160; </div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00216"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#a54e8ae206c31d9f5519115dd2c7ababf">  216</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#a54e8ae206c31d9f5519115dd2c7ababf">write_footer_example</a>($outputlangs)</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    {</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="comment">// return the file content as a string</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        $tempfile = tempnam(sys_get_temp_dir(), <span class="stringliteral">&#39;dol&#39;</span>);</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        $objWriter = <span class="keyword">new</span> PhpOffice\PhpSpreadsheet\Writer\Xlsx($this-&gt;workbook);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        $objWriter-&gt;save($tempfile);</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        $this-&gt;workbook-&gt;disconnectWorksheets();</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        unset($this-&gt;workbook);</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160; </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        $content = file_get_contents($tempfile);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        unlink($tempfile);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="keywordflow">return</span> $content;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    }</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160; </div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160; </div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160; </div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00240"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#a4ba7f1d4cf9d821ac39896d337632fb6">  240</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#a4ba7f1d4cf9d821ac39896d337632fb6">import_open_file</a>($file)</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    {</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        global $langs;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        $ret = 1;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160; </div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this) . <span class="stringliteral">&quot;::open_file file=&quot;</span> . $file);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160; </div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        $reader = <span class="keyword">new</span> Xlsx();</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        $this-&gt;workbook = $reader-&gt;load($file);</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        $this-&gt;record = 1;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        $this-&gt;file = $file;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160; </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        <span class="keywordflow">return</span> $ret;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    }</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160; </div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160; </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00264"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#a23659818850937d5987432a3dff0af05">  264</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#a23659818850937d5987432a3dff0af05">import_get_nb_of_lines</a>($file)</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    {</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        $reader = <span class="keyword">new</span> Xlsx();</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        $this-&gt;workbook = $reader-&gt;load($file);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160; </div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        $rowcount = $this-&gt;workbook-&gt;getActiveSheet()-&gt;getHighestDataRow();</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160; </div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        $this-&gt;workbook-&gt;disconnectWorksheets();</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        unset($this-&gt;workbook);</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160; </div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="keywordflow">return</span> $rowcount;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    }</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160; </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160; </div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00285"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#a5800ab6da8a61e728ed318fae7895b86">  285</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#a5800ab6da8a61e728ed318fae7895b86">import_read_header</a>()</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    {</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="comment">// This is not called by the import code !!!</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        $this-&gt;headers = array();</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        $xlsx = <span class="keyword">new</span> Xlsx();</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        $info = $xlsx-&gt;listWorksheetinfo($this-&gt;file);</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        $countcolumns = $info[0][<span class="stringliteral">&#39;totalColumns&#39;</span>];</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="keywordflow">for</span> ($col = 1; $col &lt;= $countcolumns; $col++) {</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            $this-&gt;headers[$col] = $this-&gt;workbook-&gt;getActiveSheet()-&gt;getCellByColumnAndRow($col, 1)-&gt;getValue();</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        }</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    }</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160; </div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160; </div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00306"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#a03863e99bd7420979a668721e95ef31b">  306</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#a03863e99bd7420979a668721e95ef31b">import_read_record</a>()</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    {</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        global $conf;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160; </div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        $rowcount = $this-&gt;workbook-&gt;getActiveSheet()-&gt;getHighestDataRow();</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <span class="keywordflow">if</span> ($this-&gt;record &gt; $rowcount) {</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        }</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        $array = array();</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        $xlsx = <span class="keyword">new</span> Xlsx();</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        $info = $xlsx-&gt;listWorksheetinfo($this-&gt;file);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        $countcolumns = $info[0][<span class="stringliteral">&#39;totalColumns&#39;</span>];</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <span class="keywordflow">for</span> ($col = 1; $col &lt;= $countcolumns; $col++) {</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            $val = $this-&gt;workbook-&gt;getActiveSheet()-&gt;getCellByColumnAndRow($col, $this-&gt;record)-&gt;getValue();</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            $array[$col][<span class="stringliteral">&#39;val&#39;</span>] = $val;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            $array[$col][<span class="stringliteral">&#39;type&#39;</span>] = (<a class="code" href="../../d9/d69/functions_8lib_8php.html#a4df903ca7651cb97e1076e3716a30c38">dol_strlen</a>($val) ? 1 : -1); <span class="comment">// If empty we consider it null</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        }</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        $this-&gt;record++;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keywordflow">return</span> $array;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    }</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160; </div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00334"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#a0d9a7da9b42d14ded79024fbe98c1ef4">  334</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#a0d9a7da9b42d14ded79024fbe98c1ef4">import_close_file</a>()</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    {</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        $this-&gt;workbook-&gt;disconnectWorksheets();</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        unset($this-&gt;workbook);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    }</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160; </div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160; </div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="comment">// What is this doing here ? it is common to all imports, is should be in the parent class</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00355"></a><span class="lineno"><a class="line" href="../../d4/d28/class_import_xlsx.html#ac2aba9ad77fd11e8422c877499bb67a4">  355</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../d4/d28/class_import_xlsx.html#ac2aba9ad77fd11e8422c877499bb67a4">import_insert</a>($arrayrecord, $array_match_file_to_database, $objimport, $maxfields, $importid, $updatekeys)</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    {</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        global $langs, $conf, $user;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        global $thirdparty_static; <span class="comment">// Specific to thirdparty import</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        global $tablewithentity_cache; <span class="comment">// Cache to avoid to call  desc at each rows on tables</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160; </div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        $error = 0;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        $warning = 0;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        $this-&gt;errors = array();</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        $this-&gt;warnings = array();</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160; </div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        <span class="comment">//dol_syslog(&quot;import_csv.modules maxfields=&quot;.$maxfields.&quot; importid=&quot;.$importid);</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160; </div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <span class="comment">//var_dump($array_match_file_to_database);</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="comment">//var_dump($arrayrecord);</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        $array_match_database_to_file = array_flip($array_match_file_to_database);</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        $sort_array_match_file_to_database = $array_match_file_to_database;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        ksort($sort_array_match_file_to_database);</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160; </div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        <span class="comment">//var_dump($sort_array_match_file_to_database);</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160; </div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        <span class="keywordflow">if</span> (count($arrayrecord) == 0 || (count($arrayrecord) == 1 &amp;&amp; empty($arrayrecord[1][<span class="stringliteral">&#39;val&#39;</span>]))) {</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;            <span class="comment">//print &#39;W&#39;;</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            $this-&gt;warnings[$warning][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;trans(<span class="stringliteral">&#39;EmptyLine&#39;</span>);</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            $this-&gt;warnings[$warning][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;EMPTY&#39;</span>;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            $warning++;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;            $last_insert_id_array = array(); <span class="comment">// store the last inserted auto_increment id for each table, so that dependent tables can be inserted with the appropriate id (eg: extrafields fk_object will be set with the last inserted object&#39;s id)</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            $updatedone = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            $insertdone = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;            <span class="comment">// For each table to insert, me make a separate insert</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            <span class="keywordflow">foreach</span> ($objimport-&gt;array_import_tables[0] as $alias =&gt; $tablename) {</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                <span class="comment">// Build sql request</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                $sql = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                $listfields = array();</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                $listvalues = array();</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                $i = 0;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                $errorforthistable = 0;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160; </div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                <span class="comment">// Define $tablewithentity_cache[$tablename] if not already defined</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                <span class="keywordflow">if</span> (!isset($tablewithentity_cache[$tablename])) {   <span class="comment">// keep this test with &quot;isset&quot;</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                    <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(<span class="stringliteral">&quot;Check if table &quot;</span> . $tablename . <span class="stringliteral">&quot; has an entity field&quot;</span>);</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                    <a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a> = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;DDLDescTable($tablename, <span class="stringliteral">&#39;entity&#39;</span>);</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>) {</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                        $obj = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;fetch_object(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>);</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                        <span class="keywordflow">if</span> ($obj) {</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                            $tablewithentity_cache[$tablename] = 1; <span class="comment">// table contains entity field</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                            $tablewithentity_cache[$tablename] = 0; <span class="comment">// table does not contains entity field</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                        }</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                        <a class="code" href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a>($this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                    }</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                    <span class="comment">//dol_syslog(&quot;Table &quot;.$tablename.&quot; check for entity into cache is &quot;.$tablewithentity_cache[$tablename]);</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                }</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160; </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                <span class="comment">// array of fields to column index</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                $arrayfield = array();</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                <span class="keywordflow">foreach</span> ($sort_array_match_file_to_database as $key =&gt; $val) {</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                    $arrayfield[$val] = ($key - 1);</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                }</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160; </div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                <span class="comment">// Loop on each fields in the match array: $key = 1..n, $val=alias of field (s.nom)</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                <span class="keywordflow">foreach</span> ($sort_array_match_file_to_database as $key =&gt; $val) {</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                    $fieldalias = preg_replace(<span class="stringliteral">&#39;/\..*$/i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $val);</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                    $fieldname = preg_replace(<span class="stringliteral">&#39;/^.*\./i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $val);</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160; </div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                    <span class="keywordflow">if</span> ($alias != $fieldalias) {</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                        <span class="keywordflow">continue</span>; <span class="comment">// Not a field of current table</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                    }</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160; </div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                    <span class="keywordflow">if</span> ($key &lt;= $maxfields) {</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                        <span class="comment">// Set $newval with value to insert and set $listvalues with sql request part for insert</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                        $newval = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                        <span class="keywordflow">if</span> ($arrayrecord[($key)][<span class="stringliteral">&#39;type&#39;</span>] &gt; 0) {</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                            $newval = $arrayrecord[($key)][<span class="stringliteral">&#39;val&#39;</span>]; <span class="comment">// If type of field into input file is not empty string (so defined into input file), we get value</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                        }</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160; </div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                        <span class="comment">// Make some tests on $newval</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160; </div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                        <span class="comment">// Is it a required field ?</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                        <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/\*/&#39;</span>, $objimport-&gt;array_import_fields[0][$val]) &amp;&amp; ((string) $newval == <span class="stringliteral">&#39;&#39;</span>)) {</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                            $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;trans(<span class="stringliteral">&#39;ErrorMissingMandatoryValue&#39;</span>, $key);</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                            $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;NOTNULL&#39;</span>;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                            $errorforthistable++;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                            $error++;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                            <span class="comment">// Test format only if field is not a missing mandatory field (field may be a value or empty but not mandatory)</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                            <span class="comment">// We convert field if required</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                            <span class="keywordflow">if</span> (!empty($objimport-&gt;array_import_convertvalue[0][$val])) {</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                                <span class="comment">//print &#39;Must convert &#39;.$newval.&#39; with rule &#39;.join(&#39;,&#39;,$objimport-&gt;array_import_convertvalue[0][$val]).&#39;. &#39;;</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                                <span class="keywordflow">if</span> ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;fetchidfromcodeid&#39;</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                                    || $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;fetchidfromref&#39;</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                                    || $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;fetchidfromcodeorlabel&#39;</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                                ) {</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                                    <span class="comment">// New val can be an id or ref. If it start with id: it is forced to id, if it start with ref: it is forced to ref. It not, we try to guess.</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                                    $isidorref = <span class="stringliteral">&#39;id&#39;</span>;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                                    <span class="keywordflow">if</span> (!is_numeric($newval) &amp;&amp; $newval != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; !preg_match(<span class="stringliteral">&#39;/^id:/i&#39;</span>, $newval)) {</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                                        $isidorref = <span class="stringliteral">&#39;ref&#39;</span>;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                                    }</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                                    $newval = preg_replace(<span class="stringliteral">&#39;/^(id|ref):/i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $newval); <span class="comment">// Remove id: or ref: that was used to force if field is id or ref</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                                    <span class="comment">//print &#39;Val is now &#39;.$newval.&#39; and is type &#39;.$isidorref.&quot;&lt;br&gt;\n&quot;;</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160; </div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                                    <span class="keywordflow">if</span> ($isidorref == <span class="stringliteral">&#39;ref&#39;</span>) {    <span class="comment">// If value into input import file is a ref, we apply the function defined into descriptor</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                                        $file = (empty($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;classfile&#39;</span>]) ? $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;file&#39;</span>] : $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;classfile&#39;</span>]);</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                                        $class = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;class&#39;</span>];</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                                        $method = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;method&#39;</span>];</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                                        <span class="keywordflow">if</span> ($this-&gt;cacheconvert[$file . <span class="charliteral">&#39;_&#39;</span> . $class . <span class="charliteral">&#39;_&#39;</span> . $method . <span class="charliteral">&#39;_&#39;</span>][$newval] != <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                                            $newval = $this-&gt;cacheconvert[$file . <span class="charliteral">&#39;_&#39;</span> . $class . <span class="charliteral">&#39;_&#39;</span> . $method . <span class="charliteral">&#39;_&#39;</span>][$newval];</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                                            $resultload = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a5b2b52738954b2638dc9aa54bf019bd6">dol_include_once</a>($file);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                                            <span class="keywordflow">if</span> (empty($resultload)) {</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                                                <a class="code" href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a>(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;Error trying to call file=&#39;</span> . $file . <span class="stringliteral">&#39;, class=&#39;</span> . $class . <span class="stringliteral">&#39;, method=&#39;</span> . $method);</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                                                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                                            }</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                                            $classinstance = <span class="keyword">new</span> $class($this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                                            <span class="comment">// Try the fetch from code or ref</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                                            $param_array = array(<span class="stringliteral">&#39;&#39;</span>, $newval);</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                                            <span class="keywordflow">if</span> ($class == <span class="stringliteral">&#39;AccountingAccount&#39;</span>) {</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                                                <span class="comment">//var_dump($arrayrecord[0][&#39;val&#39;]);</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                                                <span class="comment">/*include_once DOL_DOCUMENT_ROOT.&#39;/accountancy/class/accountancysystem.class.php&#39;;</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="comment">                                                $tmpchartofaccount = new AccountancySystem($this-&gt;db);</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="comment">                                                $tmpchartofaccount-&gt;fetch($conf-&gt;global-&gt;CHARTOFACCOUNTS);</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="comment">                                                var_dump($tmpchartofaccount-&gt;ref.&#39; - &#39;.$arrayrecord[0][&#39;val&#39;]);</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment">                                                if ((! ($conf-&gt;global-&gt;CHARTOFACCOUNTS &gt; 0)) || $tmpchartofaccount-&gt;ref != $arrayrecord[0][&#39;val&#39;])</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="comment">                                                {</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="comment">                                                    $this-&gt;errors[$error][&#39;lib&#39;]=$langs-&gt;trans(&#39;ErrorImportOfChartLimitedToCurrentChart&#39;, $tmpchartofaccount-&gt;ref);</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="comment">                                                    $this-&gt;errors[$error][&#39;type&#39;]=&#39;RESTRICTONCURRENCTCHART&#39;;</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="comment">                                                    $errorforthistable++;</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="comment">                                                    $error++;</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="comment">                                                }*/</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                                                $param_array = array(<span class="stringliteral">&#39;&#39;</span>, $newval, 0, $arrayrecord[0][<span class="stringliteral">&#39;val&#39;</span>]); <span class="comment">// Param to fetch parent from account, in chart.</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                                            }</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                                            call_user_func_array(array($classinstance, $method), $param_array);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                                            <span class="comment">// If not found, try the fetch from label</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                                            <span class="keywordflow">if</span> (!($classinstance-&gt;id != <span class="stringliteral">&#39;&#39;</span>) &amp;&amp; $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;fetchidfromcodeorlabel&#39;</span>) {</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                                                $param_array = array(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $newval);</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                                                call_user_func_array(array($classinstance, $method), $param_array);</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                                            }</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                                            $this-&gt;cacheconvert[$file . <span class="charliteral">&#39;_&#39;</span> . $class . <span class="charliteral">&#39;_&#39;</span> . $method . <span class="charliteral">&#39;_&#39;</span>][$newval] = $classinstance-&gt;id;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                                            <span class="comment">//print &#39;We have made a &#39;.$class.&#39;-&gt;&#39;.$method.&#39; to get id from code &#39;.$newval.&#39;. &#39;;</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                                            <span class="keywordflow">if</span> ($classinstance-&gt;id != <span class="stringliteral">&#39;&#39;</span>) { <span class="comment">// id may be 0, it is a found value</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                                                $newval = $classinstance-&gt;id;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                                            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                                                <span class="keywordflow">if</span> (!empty($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;dict&#39;</span>])) {</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;trans(<span class="stringliteral">&#39;ErrorFieldValueNotIn&#39;</span>, $key, $newval, <span class="stringliteral">&#39;code&#39;</span>, $langs-&gt;transnoentitiesnoconv($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;dict&#39;</span>]));</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                                                } elseif (!empty($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;element&#39;</span>])) {</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;trans(<span class="stringliteral">&#39;ErrorFieldRefNotIn&#39;</span>, $key, $newval, $langs-&gt;transnoentitiesnoconv($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;element&#39;</span>]));</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                                                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = <span class="stringliteral">&#39;ErrorBadDefinitionOfImportProfile&#39;</span>;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                                                }</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                                                $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;FOREIGNKEY&#39;</span>;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                                                $errorforthistable++;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                                                $error++;</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                                            }</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                                        }</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                                    }</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;fetchidfromcodeandlabel&#39;</span>) {</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                                    $isidorref = <span class="stringliteral">&#39;id&#39;</span>;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                                    <span class="keywordflow">if</span> (!is_numeric($newval) &amp;&amp; $newval != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; !preg_match(<span class="stringliteral">&#39;/^id:/i&#39;</span>, $newval)) {</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                                        $isidorref = <span class="stringliteral">&#39;ref&#39;</span>;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                                    }</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                                    $newval = preg_replace(<span class="stringliteral">&#39;/^(id|ref):/i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $newval);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160; </div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                                    <span class="keywordflow">if</span> ($isidorref == <span class="stringliteral">&#39;ref&#39;</span>) {</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                                        $file = (empty($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;classfile&#39;</span>]) ? $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;file&#39;</span>] : $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;classfile&#39;</span>]);</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                                        $class = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;class&#39;</span>];</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                                        $method = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;method&#39;</span>];</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                                        $codefromfield = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;codefromfield&#39;</span>];</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                                        $code = $arrayrecord[$arrayfield[$codefromfield]][<span class="stringliteral">&#39;val&#39;</span>];</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                                        <span class="keywordflow">if</span> ($this-&gt;cacheconvert[$file . <span class="charliteral">&#39;_&#39;</span> . $class . <span class="charliteral">&#39;_&#39;</span> . $method . <span class="charliteral">&#39;_&#39;</span> . $code][$newval] != <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                                            $newval = $this-&gt;cacheconvert[$file . <span class="charliteral">&#39;_&#39;</span> . $class . <span class="charliteral">&#39;_&#39;</span> . $method . <span class="charliteral">&#39;_&#39;</span> . $code][$newval];</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                                            $resultload = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a5b2b52738954b2638dc9aa54bf019bd6">dol_include_once</a>($file);</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                                            <span class="keywordflow">if</span> (empty($resultload)) {</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                                                <a class="code" href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a>(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;Error trying to call file=&#39;</span> . $file . <span class="stringliteral">&#39;, class=&#39;</span> . $class . <span class="stringliteral">&#39;, method=&#39;</span> . $method . <span class="stringliteral">&#39;, code=&#39;</span> . $code);</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                                                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                                            }</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                                            $classinstance = <span class="keyword">new</span> $class($this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                                            <span class="comment">// Try the fetch from code and ref</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                                            $param_array = array(<span class="stringliteral">&#39;&#39;</span>, $newval, $code);</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                                            call_user_func_array(array($classinstance, $method), $param_array);</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                                            $this-&gt;cacheconvert[$file . <span class="charliteral">&#39;_&#39;</span> . $class . <span class="charliteral">&#39;_&#39;</span> . $method . <span class="charliteral">&#39;_&#39;</span> . $code][$newval] = $classinstance-&gt;id;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                                            <span class="keywordflow">if</span> ($classinstance-&gt;id &gt; 0) {    <span class="comment">// we found record</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                                                $newval = $classinstance-&gt;id;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                                            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                                                <span class="keywordflow">if</span> (!empty($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;dict&#39;</span>])) {</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;trans(<span class="stringliteral">&#39;ErrorFieldValueNotIn&#39;</span>, $key, $newval, <span class="stringliteral">&#39;scale&#39;</span>, $langs-&gt;transnoentitiesnoconv($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;dict&#39;</span>]));</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                                                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = <span class="stringliteral">&#39;ErrorFieldValueNotIn&#39;</span>;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                                                }</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                                                $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;FOREIGNKEY&#39;</span>;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                                                $errorforthistable++;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                                                $error++;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                                            }</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                                        }</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                                    }</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;zeroifnull&#39;</span>) {</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                                    <span class="keywordflow">if</span> (empty($newval)) {</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                                        $newval = <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                                    }</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;fetchidfromcodeunits&#39;</span> || $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;fetchscalefromcodeunits&#39;</span>) {</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                                    $file = (empty($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;classfile&#39;</span>]) ? $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;file&#39;</span>] : $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;classfile&#39;</span>]);</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                                    $class = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;class&#39;</span>];</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                                    $method = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;method&#39;</span>];</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                                    $units = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;units&#39;</span>];</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                                    <span class="keywordflow">if</span> ($this-&gt;cacheconvert[$file . <span class="charliteral">&#39;_&#39;</span> . $class . <span class="charliteral">&#39;_&#39;</span> . $method . <span class="charliteral">&#39;_&#39;</span> . $units][$newval] != <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                                        $newval = $this-&gt;cacheconvert[$file . <span class="charliteral">&#39;_&#39;</span> . $class . <span class="charliteral">&#39;_&#39;</span> . $method . <span class="charliteral">&#39;_&#39;</span> . $units][$newval];</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                                        $resultload = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a5b2b52738954b2638dc9aa54bf019bd6">dol_include_once</a>($file);</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                                        <span class="keywordflow">if</span> (empty($resultload)) {</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                                            <a class="code" href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a>(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;Error trying to call file=&#39;</span> . $file . <span class="stringliteral">&#39;, class=&#39;</span> . $class . <span class="stringliteral">&#39;, method=&#39;</span> . $method . <span class="stringliteral">&#39;, units=&#39;</span> . $units);</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                                        }</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                                        $classinstance = <span class="keyword">new</span> $class($this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                                        <span class="comment">// Try the fetch from code or ref</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                                        call_user_func_array(array($classinstance, $method), array(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $newval, $units));</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                                        $scaleorid = (($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;fetchidfromcodeunits&#39;</span>) ? $classinstance-&gt;id : $classinstance-&gt;scale);</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                                        $this-&gt;cacheconvert[$file . <span class="charliteral">&#39;_&#39;</span> . $class . <span class="charliteral">&#39;_&#39;</span> . $method . <span class="charliteral">&#39;_&#39;</span> . $units][$newval] = $scaleorid;</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                                        <span class="comment">//print &#39;We have made a &#39;.$class.&#39;-&gt;&#39;.$method.&quot; to get a value from key &#39;&quot;.$newval.&quot;&#39; and we got &#39;&quot;.$scaleorid.&quot;&#39;.&quot;;exit;</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                                        <span class="keywordflow">if</span> ($classinstance-&gt;id &gt; 0) {   <span class="comment">// we found record</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                                            $newval = $scaleorid ? $scaleorid : 0;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                                            <span class="keywordflow">if</span> (!empty($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;dict&#39;</span>])) {</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                                                $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;trans(<span class="stringliteral">&#39;ErrorFieldValueNotIn&#39;</span>, $key, $newval, <span class="stringliteral">&#39;scale&#39;</span>, $langs-&gt;transnoentitiesnoconv($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;dict&#39;</span>]));</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                                            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                                                $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = <span class="stringliteral">&#39;ErrorFieldValueNotIn&#39;</span>;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                                            }</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                                            $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;FOREIGNKEY&#39;</span>;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                                            $errorforthistable++;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                                            $error++;</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                                        }</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                                    }</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;getcustomercodeifauto&#39;</span>) {</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                                    <span class="keywordflow">if</span> (strtolower($newval) == <span class="stringliteral">&#39;auto&#39;</span>) {</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                                        $this-&gt;thirpartyobject-&gt;get_codeclient(0, 0);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                                        $newval = $this-&gt;thirpartyobject-&gt;code_client;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                                        <span class="comment">//print &#39;code_client=&#39;.$newval;</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                                    }</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                                    <span class="keywordflow">if</span> (empty($newval)) {</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                                        $arrayrecord[($key)][<span class="stringliteral">&#39;type&#39;</span>] = -1; <span class="comment">// If we get empty value, we will use &quot;null&quot;</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                                    }</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;getsuppliercodeifauto&#39;</span>) {</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                                    <span class="keywordflow">if</span> (strtolower($newval) == <span class="stringliteral">&#39;auto&#39;</span>) {</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                                        $newval = $this-&gt;thirpartyobject-&gt;get_codefournisseur(0, 1);</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                                        $newval = $this-&gt;thirpartyobject-&gt;code_fournisseur;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                                        <span class="comment">//print &#39;code_fournisseur=&#39;.$newval;</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                                    }</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                                    <span class="keywordflow">if</span> (empty($newval)) {</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                                        $arrayrecord[($key)][<span class="stringliteral">&#39;type&#39;</span>] = -1; <span class="comment">// If we get empty value, we will use &quot;null&quot;</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                                    }</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;getcustomeraccountancycodeifauto&#39;</span>) {</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                                    <span class="keywordflow">if</span> (strtolower($newval) == <span class="stringliteral">&#39;auto&#39;</span>) {</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                                        $this-&gt;thirpartyobject-&gt;get_codecompta(<span class="stringliteral">&#39;customer&#39;</span>);</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                                        $newval = $this-&gt;thirpartyobject-&gt;code_compta;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                                        <span class="comment">//print &#39;code_compta=&#39;.$newval;</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                                    }</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                                    <span class="keywordflow">if</span> (empty($newval)) {</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                                        $arrayrecord[($key)][<span class="stringliteral">&#39;type&#39;</span>] = -1; <span class="comment">// If we get empty value, we will use &quot;null&quot;</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                                    }</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;getsupplieraccountancycodeifauto&#39;</span>) {</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                                    <span class="keywordflow">if</span> (strtolower($newval) == <span class="stringliteral">&#39;auto&#39;</span>) {</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                                        $this-&gt;thirpartyobject-&gt;get_codecompta(<span class="stringliteral">&#39;supplier&#39;</span>);</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                                        $newval = $this-&gt;thirpartyobject-&gt;code_compta_fournisseur;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                                        <span class="keywordflow">if</span> (empty($newval)) {</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                                            $arrayrecord[($key - 1)][<span class="stringliteral">&#39;type&#39;</span>] = -1; <span class="comment">// If we get empty value, we will use &quot;null&quot;</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                                        }</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                                        <span class="comment">//print &#39;code_compta_fournisseur=&#39;.$newval;</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                                    }</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                                    <span class="keywordflow">if</span> (empty($newval)) {</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                                        $arrayrecord[($key)][<span class="stringliteral">&#39;type&#39;</span>] = -1; <span class="comment">// If we get empty value, we will use &quot;null&quot;</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                                    }</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;getrefifauto&#39;</span>) {</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                                    $defaultref = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                                    <span class="comment">// TODO provide the $modTask (module of generation of ref) as parameter of import_insert function</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                                    $obj = empty($conf-&gt;global-&gt;PROJECT_TASK_ADDON) ? <span class="stringliteral">&#39;mod_task_simple&#39;</span> : $conf-&gt;global-&gt;PROJECT_TASK_ADDON;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                                    <span class="keywordflow">if</span> (!empty($conf-&gt;global-&gt;PROJECT_TASK_ADDON) &amp;&amp; is_readable(DOL_DOCUMENT_ROOT . <span class="stringliteral">&quot;/core/modules/project/task/&quot;</span> . $conf-&gt;global-&gt;PROJECT_TASK_ADDON . <span class="stringliteral">&quot;.php&quot;</span>)) {</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                                        require_once DOL_DOCUMENT_ROOT . <span class="stringliteral">&quot;/core/modules/project/task/&quot;</span> . $conf-&gt;global-&gt;PROJECT_TASK_ADDON . <span class="stringliteral">&#39;.php&#39;</span>;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                                        $modTask = <span class="keyword">new</span> $obj;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                                        $defaultref = $modTask-&gt;getNextValue(<span class="keyword">null</span>, <span class="keyword">null</span>);</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                                    }</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                                    <span class="keywordflow">if</span> (is_numeric($defaultref) &amp;&amp; $defaultref &lt;= 0) {</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                                        $defaultref = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                                    }</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                                    $newval = $defaultref;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;compute&#39;</span>) {</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                                    $file = (empty($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;classfile&#39;</span>]) ? $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;file&#39;</span>] : $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;classfile&#39;</span>]);</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                                    $class = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;class&#39;</span>];</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                                    $method = $objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;method&#39;</span>];</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                                    $resultload = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a5b2b52738954b2638dc9aa54bf019bd6">dol_include_once</a>($file);</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                                    <span class="keywordflow">if</span> (empty($resultload)) {</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                                        <a class="code" href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a>(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;Error trying to call file=&#39;</span> . $file . <span class="stringliteral">&#39;, class=&#39;</span> . $class . <span class="stringliteral">&#39;, method=&#39;</span> . $method);</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                                    }</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                                    $classinstance = <span class="keyword">new</span> $class($this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                                    $res = call_user_func_array(array($classinstance, $method), array(&amp;$arrayrecord));</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                                    <span class="keywordflow">if</span> ($res &lt; 0) {</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                                        <span class="keywordflow">if</span> (!empty($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;dict&#39;</span>])) {</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                                            $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;trans(<span class="stringliteral">&#39;ErrorFieldValueNotIn&#39;</span>, $key, $newval, <span class="stringliteral">&#39;code&#39;</span>, $langs-&gt;transnoentitiesnoconv($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;dict&#39;</span>]));</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                                            $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = <span class="stringliteral">&#39;ErrorFieldValueNotIn&#39;</span>;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                                        }</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                                        $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;FOREIGNKEY&#39;</span>;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                                        $errorforthistable++;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                                        $error++;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                                        $newval = $arrayrecord[($key)][<span class="stringliteral">&#39;val&#39;</span>]; <span class="comment">//We get new value computed.</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                                    }</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;numeric&#39;</span>) {</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                                    $newval = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a34644574d03047e0104710288a28ac91">price2num</a>($newval);</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                                } elseif ($objimport-&gt;array_import_convertvalue[0][$val][<span class="stringliteral">&#39;rule&#39;</span>] == <span class="stringliteral">&#39;accountingaccount&#39;</span>) {</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                                    <span class="keywordflow">if</span> (empty($conf-&gt;global-&gt;ACCOUNTING_MANAGE_ZERO)) {</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                                        $newval = rtrim(trim($newval), <span class="stringliteral">&quot;0&quot;</span>);</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                                        $newval = trim($newval);</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                                    }</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;                                }</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160; </div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                                <span class="comment">//print &#39;Val to use as insert is &#39;.$newval.&#39;&lt;br&gt;&#39;;</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                            }</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160; </div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                            <span class="comment">// Test regexp</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                            <span class="keywordflow">if</span> (!empty($objimport-&gt;array_import_regex[0][$val]) &amp;&amp; ($newval != <span class="stringliteral">&#39;&#39;</span>)) {</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                                <span class="comment">// If test is &quot;Must exist in a field@table or field@table:...&quot;</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                                $reg = array();</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                                <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(.+)@([^:]+)(:.+)?$/&#39;</span>, $objimport-&gt;array_import_regex[0][$val], $reg)) {</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                                    $field = $reg[1];</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                                    $table = $reg[2];</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                                    $filter = !empty($reg[3]) ? substr($reg[3], 1) : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160; </div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;                                    $cachekey = $field . <span class="charliteral">&#39;@&#39;</span> . $table;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                                    <span class="keywordflow">if</span> (!empty($filter)) {</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                                        $cachekey .= <span class="charliteral">&#39;:&#39;</span> . $filter;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                                    }</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160; </div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                                    <span class="comment">// Load content of field@table into cache array</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                                    <span class="keywordflow">if</span> (!is_array($this-&gt;cachefieldtable[$cachekey])) { <span class="comment">// If content of field@table not already loaded into cache</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                                        $sql = <span class="stringliteral">&quot;SELECT &quot;</span> . $field . <span class="stringliteral">&quot; as aliasfield FROM &quot;</span> . $table;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;                                        <span class="keywordflow">if</span> (!empty($filter)) {</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;                                            $sql .= <span class="stringliteral">&#39; WHERE &#39;</span> . $filter;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;                                        }</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160; </div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                                        <a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a> = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                                        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>) {</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;                                            $num = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;num_rows(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>);</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                                            $i = 0;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                                            <span class="keywordflow">while</span> ($i &lt; $num) {</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                                                $obj = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;fetch_object(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>);</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                                                <span class="keywordflow">if</span> ($obj) {</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                                                    $this-&gt;cachefieldtable[$cachekey][] = $obj-&gt;aliasfield;</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                                                }</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                                                $i++;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                                            }</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                                            <a class="code" href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a>($this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;                                        }</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                                    }</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                                    <span class="comment">// Now we check cache is not empty (should not) and key is into cache</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                                    <span class="keywordflow">if</span> (!is_array($this-&gt;cachefieldtable[$cachekey]) || !in_array($newval, $this-&gt;cachefieldtable[$cachekey])) {</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                                        $tableforerror = $table;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                                        <span class="keywordflow">if</span> (!empty($filter)) {</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                                            $tableforerror .= <span class="charliteral">&#39;:&#39;</span> . $filter;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                                        }</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                                        $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;transnoentitiesnoconv(<span class="stringliteral">&#39;ErrorFieldValueNotIn&#39;</span>, $key, $newval, $field, $tableforerror);</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                                        $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;FOREIGNKEY&#39;</span>;</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                                        $errorforthistable++;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;                                        $error++;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;                                    }</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                                } elseif (!preg_match(<span class="charliteral">&#39;/&#39;</span> . $objimport-&gt;array_import_regex[0][$val] . <span class="stringliteral">&#39;/i&#39;</span>, $newval)) {</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;                                    <span class="comment">// If test is just a static regex</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                                    <span class="comment">//if ($key == 19) print &quot;xxx&quot;.$newval.&quot;zzz&quot;.$objimport-&gt;array_import_regex[0][$val].&quot;&lt;br&gt;&quot;;</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;transnoentitiesnoconv(<span class="stringliteral">&#39;ErrorWrongValueForField&#39;</span>, $key, $newval, $objimport-&gt;array_import_regex[0][$val]);</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;REGEX&#39;</span>;</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;                                    $errorforthistable++;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                                    $error++;</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                                }</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                            }</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160; </div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                            <span class="comment">// Other tests</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                            <span class="comment">// ...</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                        }</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160; </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                        <span class="comment">// Define $listfields and $listvalues to build SQL request</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                        $listfields[] = $fieldname;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160; </div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                        <span class="comment">// Note: arrayrecord (and &#39;type&#39;) is filled with -&gt;import_read_record called by import.php page before calling import_insert</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                        <span class="keywordflow">if</span> (empty($newval) &amp;&amp; $arrayrecord[($key)][<span class="stringliteral">&#39;type&#39;</span>] &lt; 0) {</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                            $listvalues[] = ($newval == <span class="charliteral">&#39;0&#39;</span> ? $newval : <span class="stringliteral">&quot;null&quot;</span>);</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                        } elseif (empty($newval) &amp;&amp; $arrayrecord[($key)][<span class="stringliteral">&#39;type&#39;</span>] == 0) {</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                            $listvalues[] = <span class="stringliteral">&quot;&#39;&#39;&quot;</span>;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                            $listvalues[] = <span class="stringliteral">&quot;&#39;&quot;</span> . $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;escape($newval) . <span class="stringliteral">&quot;&#39;&quot;</span>;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                        }</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                    }</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                    $i++;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                }</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160; </div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                <span class="comment">// We add hidden fields (but only if there is at least one field to add into table)</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                <span class="keywordflow">if</span> (!empty($listfields) &amp;&amp; is_array($objimport-&gt;array_import_fieldshidden[0])) {</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                    <span class="comment">// Loop on each hidden fields to add them into listfields/listvalues</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                    <span class="keywordflow">foreach</span> ($objimport-&gt;array_import_fieldshidden[0] as $key =&gt; $val) {</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                        <span class="keywordflow">if</span> (!preg_match(<span class="stringliteral">&#39;/^&#39;</span> . preg_quote($alias, <span class="charliteral">&#39;/&#39;</span>) . <span class="stringliteral">&#39;\./&#39;</span>, $key)) {</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;                            <span class="keywordflow">continue</span>; <span class="comment">// Not a field of current table</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                        }</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                        <span class="keywordflow">if</span> ($val == <span class="stringliteral">&#39;user-&gt;id&#39;</span>) {</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;                            $listfields[] = preg_replace(<span class="stringliteral">&#39;/^&#39;</span> . preg_quote($alias, <span class="charliteral">&#39;/&#39;</span>) . <span class="stringliteral">&#39;\./&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $key);</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                            $listvalues[] = ((int) $user-&gt;id);</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;                        } elseif (preg_match(<span class="stringliteral">&#39;/^lastrowid-/&#39;</span>, $val)) {</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;                            $tmp = explode(<span class="charliteral">&#39;-&#39;</span>, $val);</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;                            $lastinsertid = (isset($last_insert_id_array[$tmp[1]])) ? $last_insert_id_array[$tmp[1]] : 0;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                            $keyfield = preg_replace(<span class="stringliteral">&#39;/^&#39;</span> . preg_quote($alias, <span class="charliteral">&#39;/&#39;</span>) . <span class="stringliteral">&#39;\./&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $key);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                            $listfields[] = $keyfield;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;                            $listvalues[] = $lastinsertid;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;                            <span class="comment">//print $key.&quot;-&quot;.$val.&quot;-&quot;.$listfields.&quot;-&quot;.$listvalues.&quot;&lt;br&gt;&quot;;exit;</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;                        } elseif (preg_match(<span class="stringliteral">&#39;/^const-/&#39;</span>, $val)) {</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;                            $tmp = explode(<span class="charliteral">&#39;-&#39;</span>, $val, 2);</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;                            $listfields[] = preg_replace(<span class="stringliteral">&#39;/^&#39;</span> . preg_quote($alias, <span class="charliteral">&#39;/&#39;</span>) . <span class="stringliteral">&#39;\./&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $key);</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                            $listvalues[] = <span class="stringliteral">&quot;&#39;&quot;</span> . $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;escape($tmp[1]) . <span class="stringliteral">&quot;&#39;&quot;</span>;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                            $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = <span class="stringliteral">&#39;Bad value of profile setup &#39;</span> . $val . <span class="stringliteral">&#39; for array_import_fieldshidden&#39;</span>;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                            $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;Import profile setup&#39;</span>;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                            $error++;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                        }</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                    }</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                }</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                <span class="comment">//print &#39;listfields=&#39;.$listfields.&#39;&lt;br&gt;listvalues=&#39;.$listvalues.&#39;&lt;br&gt;&#39;;</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160; </div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                <span class="comment">// If no error for this $alias/$tablename, we have a complete $listfields and $listvalues that are defined</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                <span class="comment">// so we can try to make the insert or update now.</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                <span class="keywordflow">if</span> (!$errorforthistable) {</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                    <span class="comment">//print &quot;$alias/$tablename/$listfields/$listvalues&lt;br&gt;&quot;;</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                    <span class="keywordflow">if</span> (!empty($listfields)) {</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                        $updatedone = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                        $insertdone = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                        <span class="keywordflow">if</span> (!empty($updatekeys)) {</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                            <span class="comment">// We do SELECT to get the rowid, if we already have the rowid, it&#39;s to be used below for related tables (extrafields)</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160; </div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                            <span class="keywordflow">if</span> (empty($lastinsertid)) { <span class="comment">// No insert done yet for a parent table</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                                $sqlSelect = <span class="stringliteral">&quot;SELECT rowid FROM &quot;</span> . $tablename;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160; </div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                                $data = array_combine($listfields, $listvalues);</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                                $where = array();</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                                $filters = array();</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                                <span class="keywordflow">foreach</span> ($updatekeys as $key) {</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                                    $col = $objimport-&gt;array_import_updatekeys[0][$key];</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                                    $key = preg_replace(<span class="stringliteral">&#39;/^.*\./i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $key);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                                    $where[] = $key . <span class="stringliteral">&#39; = &#39;</span> . $data[$key];</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                                    $filters[] = $col . <span class="stringliteral">&#39; = &#39;</span> . $data[$key];</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;                                }</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                                $sqlSelect .= <span class="stringliteral">&quot; WHERE &quot;</span> . implode(<span class="stringliteral">&#39; AND &#39;</span>, $where);</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160; </div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                                <a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a> = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sqlSelect);</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>) {</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                                    $res = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;fetch_object(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>);</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>-&gt;num_rows == 1) {</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                                        $lastinsertid = $res-&gt;rowid;</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                                        $last_insert_id_array[$tablename] = $lastinsertid;</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                                    } elseif (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>-&gt;num_rows &gt; 1) {</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;                                        $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $langs-&gt;trans(<span class="stringliteral">&#39;MultipleRecordFoundWithTheseFilters&#39;</span>, implode(<span class="stringliteral">&#39;, &#39;</span>, $filters));</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                                        $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;SQL&#39;</span>;</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                                        $error++;</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                                        <span class="comment">// No record found with filters, insert will be tried below</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                                    }</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                                    <span class="comment">//print &#39;E&#39;;</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;lasterror();</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;SQL&#39;</span>;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                                    $error++;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                                }</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                                <span class="comment">// We have a last INSERT ID (got by previous pass), so we check if we have a row referencing this foreign key.</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                                <span class="comment">// This is required when updating table with some extrafields. When inserting a record in parent table, we can make</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                                <span class="comment">// a direct insert into subtable extrafields, but when me wake an update, the insertid is defined and the child record</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;                                <span class="comment">// may already exists. So we rescan the extrafield table to know if record exists or not for the rowid.</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                                <span class="comment">// Note: For extrafield tablename, we have in importfieldshidden_array an enty &#39;extra.fk_object&#39;=&gt;&#39;lastrowid-tableparent&#39; so $keyfield is &#39;fk_object&#39;</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                                $sqlSelect = <span class="stringliteral">&quot;SELECT rowid FROM &quot;</span> . $tablename;</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160; </div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                                <span class="keywordflow">if</span> (empty($keyfield)) {</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;                                    $keyfield = <span class="stringliteral">&#39;rowid&#39;</span>;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                                }</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                                $sqlSelect .= <span class="stringliteral">&quot;WHERE &quot;</span> . $keyfield . <span class="stringliteral">&quot; = &quot;</span> .((int) $lastinsertid);</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160; </div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                                <a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a> = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sqlSelect);</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>) {</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                                    $res = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;fetch_object(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>);</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>-&gt;num_rows == 1) {</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                                        <span class="comment">// We have a row referencing this last foreign key, continue with UPDATE.</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                                        <span class="comment">// No record found referencing this last foreign key,</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                                        <span class="comment">// force $lastinsertid to 0 so we INSERT below.</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                                        $lastinsertid = 0;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                                    }</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                                    <span class="comment">//print &#39;E&#39;;</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;lasterror();</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;SQL&#39;</span>;</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;                                    $error++;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;                                }</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;                            }</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160; </div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                            <span class="keywordflow">if</span> (!empty($lastinsertid)) {</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                                <span class="comment">// Build SQL UPDATE request</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                                $sqlstart = <span class="stringliteral">&quot;UPDATE &quot;</span> . $tablename;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160; </div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                                $data = array_combine($listfields, $listvalues);</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                                $set = array();</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                                <span class="keywordflow">foreach</span> ($data as $key =&gt; $val) {</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                                    $set[] = $key . <span class="stringliteral">&#39; = &#39;</span> . $val;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                                }</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                                $sqlstart .= <span class="stringliteral">&quot; SET &quot;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, $set);</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160; </div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                                <span class="keywordflow">if</span> (empty($keyfield)) {</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                                    $keyfield = <span class="stringliteral">&#39;rowid&#39;</span>;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;                                }</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                                $sqlend = <span class="stringliteral">&quot; WHERE &quot;</span> . $keyfield . <span class="stringliteral">&quot; = &quot;</span>.((int) $lastinsertid);</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160; </div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;                                $sql = $sqlstart . $sqlend;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160; </div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;                                <span class="comment">// Run update request</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;                                <a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a> = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;                                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>) {</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;                                    <span class="comment">// No error, update has been done. $this-&gt;db-&gt;db-&gt;affected_rows can be 0 if data hasn&#39;t changed</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;                                    $updatedone = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                                    <span class="comment">//print &#39;E&#39;;</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;lasterror();</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;SQL&#39;</span>;</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                                    $error++;</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;                                }</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;                            }</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;                        }</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160; </div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                        <span class="comment">// Update not done, we do insert</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;                        <span class="keywordflow">if</span> (!$error &amp;&amp; !$updatedone) {</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;                            <span class="comment">// Build SQL INSERT request</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                            $sqlstart = <span class="stringliteral">&quot;INSERT INTO &quot;</span> . $tablename . <span class="stringliteral">&quot;(&quot;</span> . implode(<span class="stringliteral">&quot;, &quot;</span>, $listfields) . <span class="stringliteral">&quot;, import_key&quot;</span>;</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                            $sqlend = <span class="stringliteral">&quot;) VALUES(&quot;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, $listvalues) . <span class="stringliteral">&quot;, &#39;&quot;</span> . $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;escape($importid) . <span class="stringliteral">&quot;&#39;&quot;</span>;</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                            <span class="keywordflow">if</span> (!empty($tablewithentity_cache[$tablename])) {</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                                $sqlstart .= <span class="stringliteral">&quot;, entity&quot;</span>;</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                                $sqlend .= <span class="stringliteral">&quot;, &quot;</span> . $conf-&gt;entity;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                            }</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                            <span class="keywordflow">if</span> (!empty($objimport-&gt;array_import_tables_creator[0][$alias])) {</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                                $sqlstart .= <span class="stringliteral">&quot;, &quot;</span> . $objimport-&gt;array_import_tables_creator[0][$alias];</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                                $sqlend .= <span class="stringliteral">&quot;, &quot;</span> . $user-&gt;id;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                            }</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                            $sql = $sqlstart . $sqlend . <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                            <span class="comment">//dol_syslog(&quot;import_xlsx.modules&quot;, LOG_DEBUG);</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160; </div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                            <span class="comment">// Run insert request</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                            <span class="keywordflow">if</span> ($sql) {</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                                <a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a> = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a>) {</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                                    $last_insert_id_array[$tablename] = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;last_insert_id($tablename); <span class="comment">// store the last inserted auto_increment id for each table, so that child tables can be inserted with the appropriate id. This must be done just after the INSERT request, else we risk losing the id (because another sql query will be issued somewhere in Dolibarr).</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                                    $insertdone = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                                    <span class="comment">//print &#39;E&#39;;</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;lib&#39;</span>] = $this-&gt;<a class="code" href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;lasterror();</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                                    $this-&gt;errors[$error][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;SQL&#39;</span>;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                                    $error++;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;                                }</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                            }</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                        }</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                    }</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                    <span class="comment">/*else</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;<span class="comment">                    {</span></div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;<span class="comment">                        dol_print_error(&#39;&#39;,&#39;ErrorFieldListEmptyFor &#39;.$alias.&quot;/&quot;.$tablename);</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="comment">                    }*/</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                }</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160; </div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                <span class="keywordflow">if</span> ($error) {</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                }</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;            }</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160; </div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;            <span class="keywordflow">if</span> ($updatedone) {</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                $this-&gt;nbupdate++;</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;            }</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;            <span class="keywordflow">if</span> ($insertdone) {</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                $this-&gt;nbinsert++;</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;            }</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        }</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160; </div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    }</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="aclass_societe_html"><div class="ttname"><a href="../../dc/dbc/class_societe.html">Societe</a></div><div class="ttdoc">Class to manage third parties objects (customers, suppliers, prospects...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d91/societe_8class_8php_source.html#l00047">societe.class.php:47</a></div></div>
<div class="ttc" id="asupport_2inc_8php_html_ac5c9be6a1c1e82d353381986a8e859b6"><div class="ttname"><a href="../../d3/d71/support_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a></div><div class="ttdeci">$conf db</div><div class="ttdoc">API class for accounts.</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d71/support_2inc_8php_source.html#l00041">inc.php:41</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_ac2aba9ad77fd11e8422c877499bb67a4"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#ac2aba9ad77fd11e8422c877499bb67a4">ImportXlsx\import_insert</a></div><div class="ttdeci">import_insert($arrayrecord, $array_match_file_to_database, $objimport, $maxfields, $importid, $updatekeys)</div><div class="ttdoc">Insert a record into database.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00355">import_xlsx.modules.php:355</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a39a0441491a380f7f9fe07ee296cd2fa"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a></div><div class="ttdeci">dol_print_error($db='', $error='', $errors=null)</div><div class="ttdoc">Displays error message system with all the information to facilitate the diagnosis and the escalation...</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l04503">functions.lib.php:4503</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a5b2b52738954b2638dc9aa54bf019bd6"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a5b2b52738954b2638dc9aa54bf019bd6">dol_include_once</a></div><div class="ttdeci">if(!function_exists('dol_getprefix')) dol_include_once($relpath, $classname='')</div><div class="ttdoc">Make an include_once using default root and alternate root if it fails.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l00914">functions.lib.php:914</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_a03863e99bd7420979a668721e95ef31b"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#a03863e99bd7420979a668721e95ef31b">ImportXlsx\import_read_record</a></div><div class="ttdeci">import_read_record()</div><div class="ttdoc">Return array of next record in input file.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00306">import_xlsx.modules.php:306</a></div></div>
<div class="ttc" id="acompta_2index_8php_html_a14a5de89426ca4a6f25720be81061c90"><div class="ttname"><a href="../../d9/d3c/compta_2index_8php.html#a14a5de89426ca4a6f25720be81061c90">$resql</a></div><div class="ttdeci">if(!empty($conf-&gt;facture-&gt;enabled) &amp;&amp;!empty($user-&gt;rights-&gt;facture-&gt;lire)) if((!empty($conf-&gt;fournisseur-&gt;enabled) &amp;&amp;empty($conf-&gt;global-&gt;MAIN_USE_NEW_SUPPLIERMOD) &amp;&amp; $user-&gt;rights-&gt;fournisseur-&gt;facture-&gt;lire)||(!empty($conf-&gt;supplier_invoice-&gt;enabled) &amp;&amp; $user-&gt;rights-&gt;supplier_invoice-&gt;lire)) if(!empty($conf-&gt;don-&gt;enabled) &amp;&amp;!empty($user-&gt;rights-&gt;don-&gt;lire)) if(!empty($conf-&gt;tax-&gt;enabled) &amp;&amp;!empty($user-&gt;rights-&gt;tax-&gt;charges-&gt;lire)) if(!empty($conf-&gt;facture-&gt;enabled) &amp;&amp;!empty($conf-&gt;commande-&gt;enabled) &amp;&amp; $user-&gt;rights-&gt;commande-&gt;lire &amp;&amp;empty($conf-&gt;global-&gt;WORKFLOW_DISABLE_CREATE_INVOICE_FROM_ORDER)) $resql</div><div class="ttdoc">Social contributions to pay.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d3c/compta_2index_8php_source.html#l00733">index.php:733</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a34644574d03047e0104710288a28ac91"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a34644574d03047e0104710288a28ac91">price2num</a></div><div class="ttdeci">price2num($amount, $rounding='', $option=0)</div><div class="ttdoc">Function that return a number with universal decimal format (decimal separator is '.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l05315">functions.lib.php:5315</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_a2e845a1f0eb266b4b390e49d4226a9d5"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#a2e845a1f0eb266b4b390e49d4226a9d5">ImportXlsx\__construct</a></div><div class="ttdeci">__construct($db, $datatoimport)</div><div class="ttdoc">Constructor.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00102">import_xlsx.modules.php:102</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_a4ba7f1d4cf9d821ac39896d337632fb6"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#a4ba7f1d4cf9d821ac39896d337632fb6">ImportXlsx\import_open_file</a></div><div class="ttdeci">import_open_file($file)</div><div class="ttdoc">Open input file.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00240">import_xlsx.modules.php:240</a></div></div>
<div class="ttc" id="aclass_modele_imports_html"><div class="ttname"><a href="../../d9/d99/class_modele_imports.html">ModeleImports</a></div><div class="ttdoc">Parent class for import file readers.</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d1b/modules__import_8php_source.html#l00031">modules_import.php:31</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_af601a73af63cca748b9a57e810259372"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a></div><div class="ttdeci">dol_syslog($message, $level=LOG_INFO, $ident=0, $suffixinfilename='', $restricttologhandler='', $logcontext=null)</div><div class="ttdoc">Write log message into outputs.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l01447">functions.lib.php:1447</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a4df903ca7651cb97e1076e3716a30c38"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a4df903ca7651cb97e1076e3716a30c38">dol_strlen</a></div><div class="ttdeci">dol_strlen($string, $stringencoding='UTF-8')</div><div class="ttdoc">Make a strlen call.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l03456">functions.lib.php:3456</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_a32e1fa6a90c6a4f81959e3cb50ee9ea2"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#a32e1fa6a90c6a4f81959e3cb50ee9ea2">ImportXlsx\write_title_example</a></div><div class="ttdeci">write_title_example($outputlangs, $headerlinefields)</div><div class="ttdoc">Output title line of an example file for this format.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00170">import_xlsx.modules.php:170</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_a0d9a7da9b42d14ded79024fbe98c1ef4"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#a0d9a7da9b42d14ded79024fbe98c1ef4">ImportXlsx\import_close_file</a></div><div class="ttdeci">import_close_file()</div><div class="ttdoc">Close file handle.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00334">import_xlsx.modules.php:334</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_a5800ab6da8a61e728ed318fae7895b86"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#a5800ab6da8a61e728ed318fae7895b86">ImportXlsx\import_read_header</a></div><div class="ttdeci">import_read_header()</div><div class="ttdoc">Input header line from file.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00285">import_xlsx.modules.php:285</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_a54e8ae206c31d9f5519115dd2c7ababf"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#a54e8ae206c31d9f5519115dd2c7ababf">ImportXlsx\write_footer_example</a></div><div class="ttdeci">write_footer_example($outputlangs)</div><div class="ttdoc">Output footer of an example file for this format.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00216">import_xlsx.modules.php:216</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_a04e1485cc81c5df79a3a1a3608e515a6"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#a04e1485cc81c5df79a3a1a3608e515a6">ImportXlsx\write_record_example</a></div><div class="ttdeci">write_record_example($outputlangs, $contentlinevalues)</div><div class="ttdoc">Output record of an example file for this format.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00196">import_xlsx.modules.php:196</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html">ImportXlsx</a></div><div class="ttdoc">Class to import Excel files.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00038">import_xlsx.modules.php:38</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_a23659818850937d5987432a3dff0af05"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#a23659818850937d5987432a3dff0af05">ImportXlsx\import_get_nb_of_lines</a></div><div class="ttdeci">import_get_nb_of_lines($file)</div><div class="ttdoc">Return nb of records.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00264">import_xlsx.modules.php:264</a></div></div>
<div class="ttc" id="aclass_import_xlsx_html_aca89d7487686082c2eba4597877843f1"><div class="ttname"><a href="../../d4/d28/class_import_xlsx.html#aca89d7487686082c2eba4597877843f1">ImportXlsx\write_header_example</a></div><div class="ttdeci">write_header_example($outputlangs)</div><div class="ttdoc">Output header of an example file for this format.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d93/import__xlsx_8modules_8php_source.html#l00145">import_xlsx.modules.php:145</a></div></div>
<!-- 
File added into doxygen generated documentation
-->
<hr class="footer" />
<address class="footer"><small>Generated on Tue Oct 19 2021 22:53:39 for <a href="https://www.dolibarr.org" title="ERP and CRM open source software">Dolibarr</a> by Doxygen 1.8.17 </small></address>
<br>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-9049390-16"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-9049390-16');
</script>
</body>
</html>