<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dolibarr: htdocs/product/stock/class/mouvementstock.class.php Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../dolibarr.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Dolibarr
   &#160;<span id="projectnumber">12.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('df/d47/mouvementstock_8class_8php_source.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">mouvementstock.class.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../df/d47/mouvementstock_8class_8php.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;?php</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">/* Copyright (C) 2003-2006 Rodolphe Quiedeville &lt;rodolphe@quiedeville.org&gt;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * Copyright (C) 2005-2015 Laurent Destailleur  &lt;eldy@users.sourceforge.net&gt;</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * Copyright (C) 2011      Jean Heimburger      &lt;jean@tiaris.info&gt;</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * Copyright (C) 2014      Cedric GROSS         &lt;c.gross@kreiz-it.fr&gt;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * This program is free software; you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * the Free Software Foundation; either version 3 of the License, or</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * (at your option) any later version.</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * GNU General Public License for more details.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * You should have received a copy of the GNU General Public License</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * along with this program. If not, see &lt;https://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160; </div>
<div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html">   31</a></span>&#160;<span class="keyword">class </span><a class="code" href="../../db/de0/class_mouvement_stock.html">MouvementStock</a> <span class="keyword">extends</span> <a class="code" href="../../db/d09/class_common_object.html">CommonObject</a></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;{</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    <span class="keyword">public</span> $element = <span class="stringliteral">&#39;stockmouvement&#39;</span>;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160; </div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="keyword">public</span> $table_element = <span class="stringliteral">&#39;stock_mouvement&#39;</span>;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160; </div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="keyword">public</span> $product_id;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keyword">public</span> $warehouse_id;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="keyword">public</span> $qty;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160; </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keyword">public</span> $type;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160; </div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="keyword">public</span> $tms = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="keyword">public</span> $datem = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keyword">public</span> $price;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160; </div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="keyword">public</span> $fk_user_author;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160; </div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keyword">public</span> $label;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160; </div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keyword">public</span> $fk_origin;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keyword">public</span> $origintype;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keyword">public</span> $inventorycode;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keyword">public</span> $batch;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160; </div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keyword">public</span> $origin;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160; </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="keyword">public</span> $fields = array(</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        <span class="stringliteral">&#39;rowid&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;integer&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;TechnicalID&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;notnull&#39;</span>=&gt;1, <span class="stringliteral">&#39;position&#39;</span>=&gt;10, <span class="stringliteral">&#39;showoncombobox&#39;</span>=&gt;1),</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="stringliteral">&#39;tms&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;timestamp&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;DateModification&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;notnull&#39;</span>=&gt;1, <span class="stringliteral">&#39;position&#39;</span>=&gt;15),</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="stringliteral">&#39;datem&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;datetime&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Datem&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;20),</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <span class="stringliteral">&#39;fk_product&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;integer:Product:product/class/product.class.php:1&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Product&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;notnull&#39;</span>=&gt;1, <span class="stringliteral">&#39;position&#39;</span>=&gt;25),</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="stringliteral">&#39;fk_entrepot&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;integer:Entrepot:product/stock/class/entrepot.class.php&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Warehouse&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;notnull&#39;</span>=&gt;1, <span class="stringliteral">&#39;position&#39;</span>=&gt;30),</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        <span class="stringliteral">&#39;value&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;double&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Value&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;35),</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <span class="stringliteral">&#39;price&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;double(24,8)&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Price&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;40),</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <span class="stringliteral">&#39;type_mouvement&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;smallint(6)&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Type mouvement&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;45),</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        <span class="stringliteral">&#39;fk_user_author&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;integer:User:user/class/user.class.php&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Fk user author&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;50),</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="stringliteral">&#39;label&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;varchar(255)&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Label&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;55),</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        <span class="stringliteral">&#39;fk_origin&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;integer&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Fk origin&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;60),</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <span class="stringliteral">&#39;origintype&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;varchar(32)&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Origintype&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;65),</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        <span class="stringliteral">&#39;model_pdf&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;varchar(255)&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Model pdf&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;0, <span class="stringliteral">&#39;position&#39;</span>=&gt;70),</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="stringliteral">&#39;fk_projet&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;integer:Project:projet/class/project.class.php:1:fk_statut=1&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Project&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;notnull&#39;</span>=&gt;1, <span class="stringliteral">&#39;position&#39;</span>=&gt;75),</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="stringliteral">&#39;inventorycode&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;varchar(128)&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;InventoryCode&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;80),</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        <span class="stringliteral">&#39;batch&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;varchar(30)&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Batch&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;85),</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        <span class="stringliteral">&#39;eatby&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;date&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Eatby&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;90),</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        <span class="stringliteral">&#39;sellby&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;date&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Sellby&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;95),</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <span class="stringliteral">&#39;fk_project&#39;</span> =&gt;array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;integer:Project:projet/class/project.class.php:1:fk_statut=1&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>=&gt;<span class="stringliteral">&#39;Fk project&#39;</span>, <span class="stringliteral">&#39;enabled&#39;</span>=&gt;1, <span class="stringliteral">&#39;visible&#39;</span>=&gt;-1, <span class="stringliteral">&#39;position&#39;</span>=&gt;100),</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    );</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; </div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160; </div>
<div class="line"><a name="l00114"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a800f8efee13692788b13ee57c5960092">  114</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a800f8efee13692788b13ee57c5960092">__construct</a>($db)</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    {</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a> = $db;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160; </div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.PublicUnderscore</span></div>
<div class="line"><a name="l00143"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#ac8e88a1be83e6a946c6645cb92adc4c8">  143</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#ac8e88a1be83e6a946c6645cb92adc4c8">_create</a>($user, $fk_product, $entrepot_id, $qty, $type, $price = 0, $label = <span class="stringliteral">&#39;&#39;</span>, $inventorycode = <span class="stringliteral">&#39;&#39;</span>, $datem = <span class="stringliteral">&#39;&#39;</span>, $eatby = <span class="stringliteral">&#39;&#39;</span>, $sellby = <span class="stringliteral">&#39;&#39;</span>, $batch = <span class="stringliteral">&#39;&#39;</span>, $skip_batch = <span class="keyword">false</span>, $id_product_batch = 0)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    {</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="comment">// phpcs:disable</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        global $conf, $langs;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160; </div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/product/class/product.class.php&#39;</span>;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/product/stock/class/productlot.class.php&#39;</span>;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160; </div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        $error = 0;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::_create start userid=$user-&gt;id, fk_product=$fk_product, warehouse_id=$entrepot_id, qty=$qty, type=$type, price=$price, label=$label, inventorycode=$inventorycode, datem=&quot;</span>.$datem.<span class="stringliteral">&quot;, eatby=&quot;</span>.$eatby.<span class="stringliteral">&quot;, sellby=&quot;</span>.$sellby.<span class="stringliteral">&quot;, batch=&quot;</span>.$batch.<span class="stringliteral">&quot;, skip_batch=&quot;</span>.$skip_batch);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <span class="comment">// Clean parameters</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="keywordflow">if</span> (empty($price)) $price = 0;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        $now = (!empty($datem) ? $datem : <a class="code" href="../../d9/d69/functions_8lib_8php.html#a0144f55739ee9aeae74eeb8796a6f498">dol_now</a>());</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160; </div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="comment">// Check parameters</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keywordflow">if</span> (empty($fk_product)) <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <span class="keywordflow">if</span> ($eatby &lt; 0)</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        {</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            $this-&gt;errors[] = <span class="stringliteral">&#39;ErrorBadValueForParameterEatBy&#39;</span>;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <span class="keywordflow">if</span> ($sellby &lt; 0)</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        {</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            $this-&gt;errors[] = <span class="stringliteral">&#39;ErrorBadValueForParameterSellBy&#39;</span>;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        }</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="comment">// Set properties of movement</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        $this-&gt;product_id = $fk_product;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        $this-&gt;entrepot_id = $entrepot_id; <span class="comment">// deprecated</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        $this-&gt;warehouse_id = $entrepot_id;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        $this-&gt;qty = $qty;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        $this-&gt;<a class="code" href="../../d1/d2d/repair_8php.html#aeb426eab229a79c49626c27a34ea0a90">type</a> = $type;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        $this-&gt;<a class="code" href="../../d9/d69/functions_8lib_8php.html#a4f4158875f7336eb9999442262e48eee">price</a> = $price;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        $this-&gt;label = $label;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        $this-&gt;inventorycode = $inventorycode;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        $this-&gt;datem = $now;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        $this-&gt;batch = $batch;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160; </div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        $mvid = 0;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        $product = <span class="keyword">new</span> <a class="code" href="../../dc/d42/class_product.html">Product</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160; </div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        $result = $product-&gt;fetch($fk_product);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="keywordflow">if</span> ($result &lt; 0) {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            $this-&gt;error = $product-&gt;error;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;            $this-&gt;errors = $product-&gt;errors;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;            <a class="code" href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a>(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&quot;Failed to fetch product&quot;</span>);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        }</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keywordflow">if</span> ($product-&gt;id &lt;= 0) {    <span class="comment">// Can happen if database is corrupted</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        }</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160; </div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;begin();</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160; </div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        $product-&gt;load_stock(<span class="stringliteral">&#39;novirtual&#39;</span>);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="comment">// Test if product require batch data. If yes, and there is not, we throw an error.</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <span class="keywordflow">if</span> (!empty($conf-&gt;productbatch-&gt;enabled) &amp;&amp; $product-&gt;hasbatch() &amp;&amp; !$skip_batch)</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        {</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;            <span class="keywordflow">if</span> (empty($batch))</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            {</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                $langs-&gt;load(<span class="stringliteral">&quot;errors&quot;</span>);</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                $this-&gt;errors[] = $langs-&gt;transnoentitiesnoconv(<span class="stringliteral">&quot;ErrorTryToMakeMoveOnProductRequiringBatchData&quot;</span>, $product-&gt;ref);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(<span class="stringliteral">&quot;Try to make a movement of a product with status_batch on without any batch data&quot;</span>);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160; </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                <span class="keywordflow">return</span> -2;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            }</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            <span class="comment">// Check table llx_product_lot from batchnumber for same product</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            <span class="comment">// If found and eatby/sellby defined into table and provided and differs, return error</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;            <span class="comment">// If found and eatby/sellby defined into table and not provided, we take value from table</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            <span class="comment">// If found and eatby/sellby not defined into table and provided, we update table</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;            <span class="comment">// If found and eatby/sellby not defined into table and not provided, we do nothing</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;            <span class="comment">// If not found, we add record</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            $sql = <span class="stringliteral">&quot;SELECT pb.rowid, pb.batch, pb.eatby, pb.sellby FROM &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;product_lot as pb&quot;</span>;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;            $sql .= <span class="stringliteral">&quot; WHERE pb.fk_product = &quot;</span>.$fk_product.<span class="stringliteral">&quot; AND pb.batch = &#39;&quot;</span>.$this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;escape($batch).<span class="stringliteral">&quot;&#39;&quot;</span>;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;            <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::_create scan serial for this product to check if eatby and sellby match&quot;</span>, LOG_DEBUG);</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            <a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a> = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>)</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            {</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                $num = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;num_rows(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                $i = 0;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                <span class="keywordflow">if</span> ($num &gt; 0)</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                {</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                    <span class="keywordflow">while</span> ($i &lt; $num)</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                    {</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                        $obj = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;fetch_object(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                        <span class="keywordflow">if</span> ($obj-&gt;eatby)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                        {</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                            <span class="keywordflow">if</span> ($eatby)</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                            {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                                $tmparray = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a0c15a8be3998272a30daa20a5a7c0ab2">dol_getdate</a>($eatby, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                                $eatbywithouthour = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a7bb2f80ee033060c3f3be6a8d7cc9c84">dol_mktime</a>(0, 0, 0, $tmparray[<span class="stringliteral">&#39;mon&#39;</span>], $tmparray[<span class="stringliteral">&#39;mday&#39;</span>], $tmparray[<span class="stringliteral">&#39;year&#39;</span>]);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                                <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;eatby) != $eatby &amp;&amp; $this-&gt;db-&gt;jdate($obj-&gt;eatby) != $eatbywithouthour)    <span class="comment">// We test date without hours and with hours for backward compatibility</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                                {</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                                    <span class="comment">// If found and eatby/sellby defined into table and provided and differs, return error</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                                    $langs-&gt;load(<span class="stringliteral">&quot;stocks&quot;</span>);</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                                    $this-&gt;errors[] = $langs-&gt;transnoentitiesnoconv(<span class="stringliteral">&quot;ThisSerialAlreadyExistWithDifferentDate&quot;</span>, $batch, <a class="code" href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;eatby), <span class="stringliteral">&#39;dayhour&#39;</span>), <a class="code" href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a>($eatbywithouthour, <span class="stringliteral">&#39;dayhour&#39;</span>));</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                                    <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(<span class="stringliteral">&quot;ThisSerialAlreadyExistWithDifferentDate batch=&quot;</span>.$batch.<span class="stringliteral">&quot;, eatby found into product_lot = &quot;</span>.$obj-&gt;eatby.<span class="stringliteral">&quot; = &quot;</span>.<a class="code" href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;eatby), <span class="stringliteral">&#39;dayhourrfc&#39;</span>).<span class="stringliteral">&quot; so eatbywithouthour = &quot;</span>.$eatbywithouthour.<span class="stringliteral">&quot; = &quot;</span>.<a class="code" href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a>($eatbywithouthour).<span class="stringliteral">&quot; - eatby provided = &quot;</span>.$eatby.<span class="stringliteral">&quot; = &quot;</span>.<a class="code" href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a>($eatby, <span class="stringliteral">&#39;dayhourrfc&#39;</span>), LOG_ERR);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                                    $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                                    <span class="keywordflow">return</span> -3;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                                }</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                            }</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                            {</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                                $eatby = $obj-&gt;eatby; <span class="comment">// If found and eatby/sellby defined into table and not provided, we take value from table</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                            }</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                        }</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                        {</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                            <span class="keywordflow">if</span> ($eatby) <span class="comment">// If found and eatby/sellby not defined into table and provided, we update table</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                            {</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                                $productlot = <span class="keyword">new</span> <a class="code" href="../../d1/d07/class_productlot.html">Productlot</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                                $result = $productlot-&gt;fetch($obj-&gt;rowid);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                                $productlot-&gt;eatby = $eatby;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                                $result = $productlot-&gt;update($user);</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                                <span class="keywordflow">if</span> ($result &lt;= 0)</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                                {</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                                    $this-&gt;error = $productlot-&gt;error;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                                    $this-&gt;errors = $productlot-&gt;errors;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                                    $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                                    <span class="keywordflow">return</span> -5;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                                }</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                            }</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                        }</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                        <span class="keywordflow">if</span> ($obj-&gt;sellby)</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                        {</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                            <span class="keywordflow">if</span> ($sellby)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                            {</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                                $tmparray = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a0c15a8be3998272a30daa20a5a7c0ab2">dol_getdate</a>($sellby, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                                $sellbywithouthour = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a7bb2f80ee033060c3f3be6a8d7cc9c84">dol_mktime</a>(0, 0, 0, $tmparray[<span class="stringliteral">&#39;mon&#39;</span>], $tmparray[<span class="stringliteral">&#39;mday&#39;</span>], $tmparray[<span class="stringliteral">&#39;year&#39;</span>]);</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                                <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;sellby) != $sellby &amp;&amp; $this-&gt;db-&gt;jdate($obj-&gt;sellby) != $sellbywithouthour)    <span class="comment">// We test date without hours and with hours for backward compatibility</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                                {</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                                    <span class="comment">// If found and eatby/sellby defined into table and provided and differs, return error</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                                    $this-&gt;errors[] = $langs-&gt;transnoentitiesnoconv(<span class="stringliteral">&quot;ThisSerialAlreadyExistWithDifferentDate&quot;</span>, $batch, <a class="code" href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;sellby)), <a class="code" href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a>($sellby));</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                                    <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>($langs-&gt;transnoentities(<span class="stringliteral">&quot;ThisSerialAlreadyExistWithDifferentDate&quot;</span>, $batch, <a class="code" href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;sellby)), <a class="code" href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a>($sellby)), LOG_ERR);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                                    $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                                    <span class="keywordflow">return</span> -3;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                                }</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                            }</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                            {</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                                $sellby = $obj-&gt;sellby; <span class="comment">// If found and eatby/sellby defined into table and not provided, we take value from table</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                            }</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                        }</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                        {</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                            <span class="keywordflow">if</span> ($sellby) <span class="comment">// If found and eatby/sellby not defined into table and provided, we update table</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                            {</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                                $productlot = <span class="keyword">new</span> <a class="code" href="../../d1/d07/class_productlot.html">Productlot</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                                $result = $productlot-&gt;fetch($obj-&gt;rowid);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                                $productlot-&gt;sellby = $sellby;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                                $result = $productlot-&gt;update($user);</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                                <span class="keywordflow">if</span> ($result &lt;= 0)</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                                {</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                                    $this-&gt;error = $productlot-&gt;error;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                                    $this-&gt;errors = $productlot-&gt;errors;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                                    $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                                    <span class="keywordflow">return</span> -5;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                                }</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                            }</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                        }</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160; </div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                        $i++;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                    }</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                }</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                <span class="keywordflow">else</span>   <span class="comment">// If not found, we add record</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                {</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                    $productlot = <span class="keyword">new</span> <a class="code" href="../../d1/d07/class_productlot.html">Productlot</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                    $productlot-&gt;entity = $conf-&gt;entity;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                    $productlot-&gt;fk_product = $fk_product;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                    $productlot-&gt;batch = $batch;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                    <span class="comment">// If we are here = first time we manage this batch, so we used dates provided by users to create lot</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                    $productlot-&gt;eatby = $eatby;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                    $productlot-&gt;sellby = $sellby;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                    $result = $productlot-&gt;create($user);</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                    <span class="keywordflow">if</span> ($result &lt;= 0)</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                    {</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                        $this-&gt;error = $productlot-&gt;error;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                        $this-&gt;errors = $productlot-&gt;errors;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                        $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                        <span class="keywordflow">return</span> -4;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                    }</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                }</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            }</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            {</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                <a class="code" href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            }</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        }</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160; </div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        <span class="comment">// Define if we must make the stock change (If product type is a service or if stock is used also for services)</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        $movestock = 0;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        <span class="keywordflow">if</span> ($product-&gt;type != <a class="code" href="../../dc/d42/class_product.html#a8243368e8df7d3bb04055b5f083aab48">Product::TYPE_SERVICE</a> || !empty($conf-&gt;global-&gt;STOCK_SUPPORTS_SERVICES)) $movestock = 1;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160; </div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="comment">// Check if stock is enough when qty is &lt; 0</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="comment">// Note that qty should be &gt; 0 with type 0 or 3, &lt; 0 with type 1 or 2.</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="keywordflow">if</span> ($movestock &amp;&amp; $qty &lt; 0 &amp;&amp; empty($conf-&gt;global-&gt;STOCK_ALLOW_NEGATIVE_TRANSFER))</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        {</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;            <span class="keywordflow">if</span> (!empty($conf-&gt;productbatch-&gt;enabled) &amp;&amp; $product-&gt;hasbatch() &amp;&amp; !$skip_batch)</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            {</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                $foundforbatch = 0;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                $qtyisnotenough = 0;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                <span class="keywordflow">foreach</span> ($product-&gt;stock_warehouse[$entrepot_id]-&gt;detail_batch as $batchcursor =&gt; $prodbatch)</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                {</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                    <span class="keywordflow">if</span> ($batch != $batchcursor) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                    $foundforbatch = 1;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                    <span class="keywordflow">if</span> ($prodbatch-&gt;qty &lt; abs($qty)) $qtyisnotenough = $prodbatch-&gt;qty;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                }</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                <span class="keywordflow">if</span> (!$foundforbatch || $qtyisnotenough)</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                {</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                    $langs-&gt;load(<span class="stringliteral">&quot;stocks&quot;</span>);</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                    include_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/product/stock/class/entrepot.class.php&#39;</span>;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                    $tmpwarehouse = <span class="keyword">new</span> <a class="code" href="../../db/de4/class_entrepot.html">Entrepot</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                    $tmpwarehouse-&gt;fetch($entrepot_id);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160; </div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                    $this-&gt;error = $langs-&gt;trans(<span class="stringliteral">&#39;qtyToTranferLotIsNotEnough&#39;</span>, $product-&gt;ref, $batch, $qtyisnotenough, $tmpwarehouse-&gt;ref);</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                    $this-&gt;errors[] = $langs-&gt;trans(<span class="stringliteral">&#39;qtyToTranferLotIsNotEnough&#39;</span>, $product-&gt;ref, $batch, $qtyisnotenough, $tmpwarehouse-&gt;ref);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                    $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                    <span class="keywordflow">return</span> -8;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                }</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            }</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            {</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                <span class="keywordflow">if</span> (empty($product-&gt;stock_warehouse[$entrepot_id]-&gt;real) || $product-&gt;stock_warehouse[$entrepot_id]-&gt;real &lt; abs($qty))</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                {</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                    $langs-&gt;load(<span class="stringliteral">&quot;stocks&quot;</span>);</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                    $this-&gt;error = $langs-&gt;trans(<span class="stringliteral">&#39;qtyToTranferIsNotEnough&#39;</span>).<span class="stringliteral">&#39; : &#39;</span>.$product-&gt;ref;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                    $this-&gt;errors[] = $langs-&gt;trans(<span class="stringliteral">&#39;qtyToTranferIsNotEnough&#39;</span>).<span class="stringliteral">&#39; : &#39;</span>.$product-&gt;ref;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                    $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                    <span class="keywordflow">return</span> -8;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                }</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            }</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        }</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160; </div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        <span class="keywordflow">if</span> ($movestock &amp;&amp; $entrepot_id &gt; 0) <span class="comment">// Change stock for current product, change for subproduct is done after</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        {</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            <span class="comment">// Set $origintype, fk_origin, fk_project</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            $fk_project = 0;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;            <span class="keywordflow">if</span> (!empty($this-&gt;origin)) {            <span class="comment">// This is set by caller for tracking reason</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                $origintype = empty($this-&gt;origin-&gt;origin_type) ? $this-&gt;origin-&gt;element : $this-&gt;origin-&gt;origin_type;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                $fk_origin = $this-&gt;origin-&gt;id;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                <span class="keywordflow">if</span> ($origintype == <span class="stringliteral">&#39;project&#39;</span>) $fk_project = $fk_origin;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                {</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                    $res = $this-&gt;origin-&gt;fetch($fk_origin);</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                    <span class="keywordflow">if</span> ($res &gt; 0)</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                    {</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                        <span class="keywordflow">if</span> (!empty($this-&gt;origin-&gt;fk_project))</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                        {</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                            $fk_project = $this-&gt;origin-&gt;fk_project;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                        }</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                    }</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                }</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                $origintype = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                $fk_origin = 0;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                $fk_project = 0;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            }</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160; </div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;            $sql = <span class="stringliteral">&quot;INSERT INTO &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;stock_mouvement(&quot;</span>;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;            $sql .= <span class="stringliteral">&quot; datem, fk_product, batch, eatby, sellby,&quot;</span>;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;            $sql .= <span class="stringliteral">&quot; fk_entrepot, value, type_mouvement, fk_user_author, label, inventorycode, price, fk_origin, origintype, fk_projet&quot;</span>;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;            $sql .= <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;            $sql .= <span class="stringliteral">&quot; VALUES (&#39;&quot;</span>.$this-&gt;db-&gt;idate($now).<span class="stringliteral">&quot;&#39;, &quot;</span>.$this-&gt;product_id.<span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            $sql .= <span class="stringliteral">&quot; &quot;</span>.($batch ? <span class="stringliteral">&quot;&#39;&quot;</span>.$batch.<span class="stringliteral">&quot;&#39;&quot;</span> : <span class="stringliteral">&quot;null&quot;</span>).<span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            $sql .= <span class="stringliteral">&quot; &quot;</span>.($eatby ? <span class="stringliteral">&quot;&#39;&quot;</span>.$this-&gt;db-&gt;idate($eatby).<span class="stringliteral">&quot;&#39;&quot;</span> : <span class="stringliteral">&quot;null&quot;</span>).<span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;            $sql .= <span class="stringliteral">&quot; &quot;</span>.($sellby ? <span class="stringliteral">&quot;&#39;&quot;</span>.$this-&gt;db-&gt;idate($sellby).<span class="stringliteral">&quot;&#39;&quot;</span> : <span class="stringliteral">&quot;null&quot;</span>).<span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            $sql .= <span class="stringliteral">&quot; &quot;</span>.$this-&gt;entrepot_id.<span class="stringliteral">&quot;, &quot;</span>.$this-&gt;qty.<span class="stringliteral">&quot;, &quot;</span>.((int) $this-&gt;<a class="code" href="../../d1/d2d/repair_8php.html#aeb426eab229a79c49626c27a34ea0a90">type</a>).<span class="stringliteral">&quot;,&quot;</span>;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            $sql .= <span class="stringliteral">&quot; &quot;</span>.$user-&gt;id.<span class="stringliteral">&quot;,&quot;</span>;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            $sql .= <span class="stringliteral">&quot; &#39;&quot;</span>.$this-&gt;db-&gt;escape($label).<span class="stringliteral">&quot;&#39;,&quot;</span>;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            $sql .= <span class="stringliteral">&quot; &quot;</span>.($inventorycode ? <span class="stringliteral">&quot;&#39;&quot;</span>.$this-&gt;db-&gt;escape($inventorycode).<span class="stringliteral">&quot;&#39;&quot;</span> : <span class="stringliteral">&quot;null&quot;</span>).<span class="stringliteral">&quot;,&quot;</span>;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            $sql .= <span class="stringliteral">&quot; &quot;</span>.price2num($price).<span class="stringliteral">&quot;,&quot;</span>;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            $sql .= <span class="stringliteral">&quot; &quot;</span>.$fk_origin.<span class="stringliteral">&quot;,&quot;</span>;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            $sql .= <span class="stringliteral">&quot; &#39;&quot;</span>.$this-&gt;db-&gt;escape($origintype).<span class="stringliteral">&quot;&#39;,&quot;</span>;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;            $sql .= <span class="stringliteral">&quot; &quot;</span>.$fk_project;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            $sql .= <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160; </div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;            <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::_create insert record into stock_mouvement&quot;</span>, LOG_DEBUG);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;            <a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a> = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160; </div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>)</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;            {</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                $mvid = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;last_insert_id(MAIN_DB_PREFIX.<span class="stringliteral">&quot;stock_mouvement&quot;</span>);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                $this-&gt;<span class="keywordtype">id</span> = $mvid;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;            }</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            {</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                $this-&gt;error = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;lasterror();</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                $this-&gt;errors[] = $this-&gt;error;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                $error = -1;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            }</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160; </div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;            <span class="comment">// Define current values for qty and pmp</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            $oldqty = $product-&gt;stock_reel;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            $oldpmp = $product-&gt;pmp;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            $oldqtywarehouse = 0;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160; </div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            <span class="comment">// Test if there is already a record for couple (warehouse / product), so later we will make an update or create.</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;            $alreadyarecord = 0;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            <span class="keywordflow">if</span> (!$error)</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;            {</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                $sql = <span class="stringliteral">&quot;SELECT rowid, reel FROM &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;product_stock&quot;</span>;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                $sql .= <span class="stringliteral">&quot; WHERE fk_entrepot = &quot;</span>.$entrepot_id.<span class="stringliteral">&quot; AND fk_product = &quot;</span>.$fk_product; <span class="comment">// This is a unique key</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160; </div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::_create check if a record already exists in product_stock&quot;</span>, LOG_DEBUG);</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                <a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a> = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>)</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                {</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                    $obj = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;fetch_object(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>);</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                    <span class="keywordflow">if</span> ($obj)</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                    {</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                        $alreadyarecord = 1;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                        $oldqtywarehouse = $obj-&gt;reel;</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                        $fk_product_stock = $obj-&gt;rowid;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                    }</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                    $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;free(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>);</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                }</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                {</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                    $this-&gt;errors[] = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;lasterror();</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                    $error = -2;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                }</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;            }</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160; </div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;            <span class="comment">// Calculate new PMP.</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;            $newpmp = 0;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            <span class="keywordflow">if</span> (!$error)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;            {</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                <span class="keywordflow">if</span> ($type == 0 || $type == 3)</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                {</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                    <span class="comment">// After a stock increase</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                    <span class="comment">// Note: PMP is calculated on stock input only (type of movement = 0 or 3). If type == 0 or 3, qty should be &gt; 0.</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                    <span class="comment">// Note: Price should always be &gt;0 or 0. PMP should be always &gt;0 (calculated on input)</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                    <span class="keywordflow">if</span> ($price &gt; 0 || (! empty($conf-&gt;global-&gt;STOCK_UPDATE_AWP_EVEN_WHEN_ENTRY_PRICE_IS_NULL) &amp;&amp; $price ==0)) {</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                        $oldqtytouse = ($oldqty &gt;= 0 ? $oldqty : 0);</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                        <span class="comment">// We make a test on oldpmp&gt;0 to avoid to use normal rule on old data with no pmp field defined</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                        <span class="keywordflow">if</span> ($oldpmp &gt; 0) $newpmp = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a34644574d03047e0104710288a28ac91">price2num</a>((($oldqtytouse * $oldpmp) + ($qty * $price)) / ($oldqtytouse + $qty), <span class="stringliteral">&#39;MU&#39;</span>);</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                        {</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                            $newpmp = $price; <span class="comment">// For this product, PMP was not yet set. We set it to input price.</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                        }</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                        <span class="comment">//print &quot;oldqtytouse=&quot;.$oldqtytouse.&quot; oldpmp=&quot;.$oldpmp.&quot; oldqtywarehousetouse=&quot;.$oldqtywarehousetouse.&quot; &quot;;</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                        <span class="comment">//print &quot;qty=&quot;.$qty.&quot; newpmp=&quot;.$newpmp;</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                        <span class="comment">//exit;</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                        $newpmp = $oldpmp;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                    }</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                }</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                elseif ($type == 1 || $type == 2)</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                {</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                    <span class="comment">// After a stock decrease, we don&#39;t change value of the AWP/PMP of a product.</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                    $newpmp = $oldpmp;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                }</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                {</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                    <span class="comment">// Type of movement unknown</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                    $newpmp = $oldpmp;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                }</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;            }</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            <span class="comment">// Update stock quantity</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;            <span class="keywordflow">if</span> (!$error)</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;            {</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                <span class="keywordflow">if</span> ($alreadyarecord &gt; 0)</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                {</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                    $sql = <span class="stringliteral">&quot;UPDATE &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;product_stock SET reel = reel + &quot;</span>.$qty;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                    $sql .= <span class="stringliteral">&quot; WHERE fk_entrepot = &quot;</span>.$entrepot_id.<span class="stringliteral">&quot; AND fk_product = &quot;</span>.$fk_product;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                }</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                {</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                    $sql = <span class="stringliteral">&quot;INSERT INTO &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;product_stock&quot;</span>;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                    $sql .= <span class="stringliteral">&quot; (reel, fk_entrepot, fk_product) VALUES &quot;</span>;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                    $sql .= <span class="stringliteral">&quot; (&quot;</span>.$qty.<span class="stringliteral">&quot;, &quot;</span>.$entrepot_id.<span class="stringliteral">&quot;, &quot;</span>.$fk_product.<span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                }</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160; </div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::_create update stock value&quot;</span>, LOG_DEBUG);</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                <a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a> = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>)</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                {</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                    $this-&gt;errors[] = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;lasterror();</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                    $error = -3;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                }</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                elseif (empty($fk_product_stock))</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                {</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                    $fk_product_stock = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;last_insert_id(MAIN_DB_PREFIX.<span class="stringliteral">&quot;product_stock&quot;</span>);</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                }</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;            }</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160; </div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;            <span class="comment">// Update detail stock for batch product</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;            <span class="keywordflow">if</span> (!$error &amp;&amp; !empty($conf-&gt;productbatch-&gt;enabled) &amp;&amp; $product-&gt;hasbatch() &amp;&amp; !$skip_batch)</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            {</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                <span class="keywordflow">if</span> ($id_product_batch &gt; 0)</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                {</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                    $result = $this-&gt;<a class="code" href="../../db/de0/class_mouvement_stock.html#a645e06fd24262a6e61e3cef62394e8cd">createBatch</a>($id_product_batch, $qty);</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                }</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                {</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                    $param_batch = array(<span class="stringliteral">&#39;fk_product_stock&#39;</span> =&gt;$fk_product_stock, <span class="stringliteral">&#39;batchnumber&#39;</span>=&gt;$batch);</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                    $result = $this-&gt;<a class="code" href="../../db/de0/class_mouvement_stock.html#a645e06fd24262a6e61e3cef62394e8cd">createBatch</a>($param_batch, $qty);</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                }</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                <span class="keywordflow">if</span> ($result &lt; 0) $error++;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;            }</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160; </div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            <span class="comment">// Update PMP and denormalized value of stock qty at product level</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            <span class="keywordflow">if</span> (!$error)</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;            {</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                $newpmp = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a34644574d03047e0104710288a28ac91">price2num</a>($newpmp, <span class="stringliteral">&#39;MU&#39;</span>);</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160; </div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                <span class="comment">// $sql = &quot;UPDATE &quot;.MAIN_DB_PREFIX.&quot;product SET pmp = &quot;.$newpmp.&quot;, stock = &quot;.$this-&gt;db-&gt;ifsql(&quot;stock IS NULL&quot;, 0, &quot;stock&quot;) . &quot; + &quot;.$qty;</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                <span class="comment">// $sql.= &quot; WHERE rowid = &quot;.$fk_product;</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                <span class="comment">// Update pmp + denormalized fields because we change content of produt_stock. Warning: Do not use &quot;SET p.stock&quot;, does not works with pgsql</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                $sql = <span class="stringliteral">&quot;UPDATE &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;product as p SET pmp = &quot;</span>.$newpmp.<span class="stringliteral">&quot;,&quot;</span>;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                $sql .= <span class="stringliteral">&quot; stock=(SELECT SUM(ps.reel) FROM &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;product_stock as ps WHERE ps.fk_product = p.rowid)&quot;</span>;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                $sql .= <span class="stringliteral">&quot; WHERE rowid = &quot;</span>.$fk_product;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160; </div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::_create update AWP&quot;</span>, LOG_DEBUG);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                <a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a> = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>)</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                {</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                    $this-&gt;errors[] = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;lasterror();</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                    $error = -4;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                }</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;            }</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160; </div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;            <span class="comment">// If stock is now 0, we can remove entry into llx_product_stock, but only if there is no child lines into llx_product_batch (detail of batch, because we can imagine</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;            <span class="comment">// having a lot1/qty=X and lot2/qty=-X, so 0 but we must not loose repartition of different lot.</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;            $sql = <span class="stringliteral">&quot;DELETE FROM &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;product_stock WHERE reel = 0 AND rowid NOT IN (SELECT fk_product_stock FROM &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;product_batch as pb)&quot;</span>;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;            <a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a> = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;            <span class="comment">// We do not test error, it can fails if there is child in batch details</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        }</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160; </div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        <span class="comment">// Add movement for sub products (recursive call)</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        <span class="keywordflow">if</span> (!$error &amp;&amp; !empty($conf-&gt;global-&gt;PRODUIT_SOUSPRODUITS) &amp;&amp; empty($conf-&gt;global-&gt;INDEPENDANT_SUBPRODUCT_STOCK))</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        {</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            $error = $this-&gt;<a class="code" href="../../db/de0/class_mouvement_stock.html#a53f251224139972d5a82e9eee507f4f7">_createSubProduct</a>($user, $fk_product, $entrepot_id, $qty, $type, 0, $label, $inventorycode); <span class="comment">// we use 0 as price, because pmp is not changed for subproduct</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        }</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160; </div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        <span class="keywordflow">if</span> ($movestock &amp;&amp; !$error)</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        {</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            <span class="comment">// Call trigger</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            $result = $this-&gt;<a class="code" href="../../db/d09/class_common_object.html#a75b0f5e3db34fedda4338c344ef626ab">call_trigger</a>(<span class="stringliteral">&#39;STOCK_MOVEMENT&#39;</span>, $user);</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;            <span class="keywordflow">if</span> ($result &lt; 0) $error++;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            <span class="comment">// End call triggers</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        }</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160; </div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="keywordflow">if</span> (!$error)</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        {</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;            $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;commit();</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            <span class="keywordflow">return</span> $mvid;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        }</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        {</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;            $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;rollback();</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;            <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::_create error code=&quot;</span>.$error, LOG_ERR);</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            <span class="keywordflow">return</span> -6;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        }</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    }</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160; </div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160; </div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160; </div>
<div class="line"><a name="l00617"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#aca60d7c39a5e48edd6ff6ee153a803a2">  617</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#aca60d7c39a5e48edd6ff6ee153a803a2">fetch</a>($id)</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    {</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(__METHOD__, LOG_DEBUG);</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160; </div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        $sql = <span class="stringliteral">&#39;SELECT&#39;</span>;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        $sql .= <span class="stringliteral">&#39; t.rowid,&#39;</span>;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        $sql .= <span class="stringliteral">&quot; t.tms,&quot;</span>;</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        $sql .= <span class="stringliteral">&quot; t.datem,&quot;</span>;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        $sql .= <span class="stringliteral">&quot; t.fk_product,&quot;</span>;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        $sql .= <span class="stringliteral">&quot; t.fk_entrepot,&quot;</span>;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        $sql .= <span class="stringliteral">&quot; t.value,&quot;</span>;</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        $sql .= <span class="stringliteral">&quot; t.price,&quot;</span>;</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        $sql .= <span class="stringliteral">&quot; t.type_mouvement,&quot;</span>;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        $sql .= <span class="stringliteral">&quot; t.fk_user_author,&quot;</span>;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        $sql .= <span class="stringliteral">&quot; t.label,&quot;</span>;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        $sql .= <span class="stringliteral">&quot; t.fk_origin,&quot;</span>;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        $sql .= <span class="stringliteral">&quot; t.origintype,&quot;</span>;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        $sql .= <span class="stringliteral">&quot; t.inventorycode,&quot;</span>;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        $sql .= <span class="stringliteral">&quot; t.batch,&quot;</span>;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        $sql .= <span class="stringliteral">&quot; t.eatby,&quot;</span>;</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        $sql .= <span class="stringliteral">&quot; t.sellby,&quot;</span>;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        $sql .= <span class="stringliteral">&quot; t.fk_projet as fk_project&quot;</span>;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        $sql .= <span class="stringliteral">&#39; FROM &#39;</span>.MAIN_DB_PREFIX.$this-&gt;table_element.<span class="stringliteral">&#39; as t&#39;</span>;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        $sql .= <span class="stringliteral">&#39; WHERE 1 = 1&#39;</span>;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        <span class="comment">//if (null !== $ref) {</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;            <span class="comment">//$sql .= &#39; AND t.ref = &#39; . &#39;\&#39;&#39; . $ref . &#39;\&#39;&#39;;</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        <span class="comment">//} else {</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            $sql .= <span class="stringliteral">&#39; AND t.rowid = &#39;</span>.$id;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        <span class="comment">//}</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160; </div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        <a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a> = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>) {</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;            $numrows = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;num_rows(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>);</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            <span class="keywordflow">if</span> ($numrows) {</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                $obj = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;fetch_object(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160; </div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                $this-&gt;<span class="keywordtype">id</span> = $obj-&gt;rowid;</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160; </div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                $this-&gt;product_id = $obj-&gt;fk_product;</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                $this-&gt;warehouse_id = $obj-&gt;fk_entrepot;</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                $this-&gt;qty = $obj-&gt;value;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                $this-&gt;<a class="code" href="../../d1/d2d/repair_8php.html#aeb426eab229a79c49626c27a34ea0a90">type</a> = $obj-&gt;type_mouvement;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160; </div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                $this-&gt;tms = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;tms);</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                $this-&gt;datem = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;datem);</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                $this-&gt;<a class="code" href="../../d9/d69/functions_8lib_8php.html#a4f4158875f7336eb9999442262e48eee">price</a> = $obj-&gt;price;</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                $this-&gt;fk_user_author = $obj-&gt;fk_user_author;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                $this-&gt;label = $obj-&gt;label;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                $this-&gt;fk_origin = $obj-&gt;fk_origin;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                $this-&gt;origintype = $obj-&gt;origintype;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                $this-&gt;inventorycode = $obj-&gt;inventorycode;</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                $this-&gt;batch = $obj-&gt;batch;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                $this-&gt;eatby = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;eatby);</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                $this-&gt;sellby = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;jdate($obj-&gt;sellby);</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                $this-&gt;fk_project = $obj-&gt;fk_project;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;            }</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160; </div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;            <span class="comment">// Retreive all extrafield</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;            <span class="comment">// fetch optionals attributes and labels</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;            $this-&gt;<a class="code" href="../../db/d09/class_common_object.html#ad0433842f96f49b6d04192a728161ec8">fetch_optionals</a>();</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160; </div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;            <span class="comment">// $this-&gt;fetch_lines();</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160; </div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;free(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>);</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160; </div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;            <span class="keywordflow">if</span> ($numrows) {</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;            }</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            $this-&gt;errors[] = <span class="stringliteral">&#39;Error &#39;</span>.$this-&gt;db-&gt;lasterror();</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(__METHOD__.<span class="charliteral">&#39; &#39;</span>.implode(<span class="charliteral">&#39;,&#39;</span>, $this-&gt;errors), LOG_ERR);</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160; </div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        }</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    }</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160; </div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160; </div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160; </div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160; </div>
<div class="line"><a name="l00711"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a53f251224139972d5a82e9eee507f4f7">  711</a></span>&#160;    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a53f251224139972d5a82e9eee507f4f7">_createSubProduct</a>($user, $idProduct, $entrepot_id, $qty, $type, $price = 0, $label = <span class="stringliteral">&#39;&#39;</span>, $inventorycode = <span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    {</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        global $langs;</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        $error = 0;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        $pids = array();</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        $pqtys = array();</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160; </div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        $sql = <span class="stringliteral">&quot;SELECT fk_product_pere, fk_product_fils, qty&quot;</span>;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        $sql .= <span class="stringliteral">&quot; FROM &quot;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&quot;product_association&quot;</span>;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        $sql .= <span class="stringliteral">&quot; WHERE fk_product_pere = &quot;</span>.$idProduct;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        $sql .= <span class="stringliteral">&quot; AND incdec = 1&quot;</span>;</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160; </div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::_createSubProduct for parent product &quot;</span>.$idProduct, LOG_DEBUG);</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        <a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a> = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>)</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        {</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;            $i = 0;</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;            <span class="keywordflow">while</span> ($obj = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;fetch_object(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>))</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;            {</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;                $pids[$i] = $obj-&gt;fk_product_fils;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                $pqtys[$i] = $obj-&gt;qty;</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                $i++;</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;            }</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;            $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;free(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>);</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        }</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        {</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;            $error = -2;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        }</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160; </div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;        <span class="comment">// Create movement for each subproduct</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        <span class="keywordflow">foreach</span> ($pids as $key =&gt; $value)</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        {</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;            <span class="keywordflow">if</span> (!$error)</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;            {</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                $tmpmove = clone $this;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                $result = $tmpmove-&gt;_create($user, $pids[$key], $entrepot_id, ($qty * $pqtys[$key]), $type, 0, $label, $inventorycode); <span class="comment">// This will also call _createSubProduct making this recursive</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                <span class="keywordflow">if</span> ($result &lt; 0)</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                {</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                    $this-&gt;error = $tmpmove-&gt;error;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                    $this-&gt;errors = array_merge($this-&gt;errors, $tmpmove-&gt;errors);</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                    <span class="keywordflow">if</span> ($result == -2)</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                    {</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                        $this-&gt;errors[] = $langs-&gt;trans(<span class="stringliteral">&quot;ErrorNoteAlsoThatSubProductCantBeFollowedByLot&quot;</span>);</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                    }</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                    $error = $result;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                }</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                unset($tmpmove);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;            }</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        }</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160; </div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        <span class="keywordflow">return</span> $error;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    }</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160; </div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160; </div>
<div class="line"><a name="l00784"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a2f944c8af5b43fbd1983d0635ba05fc8">  784</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a2f944c8af5b43fbd1983d0635ba05fc8">livraison</a>($user, $fk_product, $entrepot_id, $qty, $price = 0, $label = <span class="stringliteral">&#39;&#39;</span>, $datem = <span class="stringliteral">&#39;&#39;</span>, $eatby = <span class="stringliteral">&#39;&#39;</span>, $sellby = <span class="stringliteral">&#39;&#39;</span>, $batch = <span class="stringliteral">&#39;&#39;</span>, $id_product_batch = 0, $inventorycode = <span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    {</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        global $conf;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160; </div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        $skip_batch = empty($conf-&gt;productbatch-&gt;enabled);</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160; </div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        <span class="keywordflow">return</span> $this-&gt;<a class="code" href="../../db/de0/class_mouvement_stock.html#ac8e88a1be83e6a946c6645cb92adc4c8">_create</a>($user, $fk_product, $entrepot_id, (0 - $qty), 2, $price, $label, $inventorycode, $datem, $eatby, $sellby, $batch, $skip_batch, $id_product_batch);</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    }</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160; </div>
<div class="line"><a name="l00810"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#ac190600157fb61d00e255bc50f2c9711">  810</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#ac190600157fb61d00e255bc50f2c9711">reception</a>($user, $fk_product, $entrepot_id, $qty, $price = 0, $label = <span class="stringliteral">&#39;&#39;</span>, $eatby = <span class="stringliteral">&#39;&#39;</span>, $sellby = <span class="stringliteral">&#39;&#39;</span>, $batch = <span class="stringliteral">&#39;&#39;</span>, $datem = <span class="stringliteral">&#39;&#39;</span>, $id_product_batch = 0, $inventorycode = <span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    {</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        global $conf;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160; </div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        $skip_batch = empty($conf-&gt;productbatch-&gt;enabled);</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160; </div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        <span class="keywordflow">return</span> $this-&gt;<a class="code" href="../../db/de0/class_mouvement_stock.html#ac8e88a1be83e6a946c6645cb92adc4c8">_create</a>($user, $fk_product, $entrepot_id, $qty, 3, $price, $label, $inventorycode, $datem, $eatby, $sellby, $batch, $skip_batch, $id_product_batch);</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    }</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160; </div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160; </div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="comment">    public function nbOfSubProducts($id)</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;<span class="comment">        $nbSP=0;</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="comment">        $resql = &quot;SELECT count(*) as nb FROM &quot;.MAIN_DB_PREFIX.&quot;product_association&quot;;</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="comment">        $resql.= &quot; WHERE fk_product_pere = &quot;.$id;</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="comment">        if ($this-&gt;db-&gt;query($resql))</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">        {</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment">            $obj=$this-&gt;db-&gt;fetch_object($resql);</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="comment">            $nbSP=$obj-&gt;nb;</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;<span class="comment">        }</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="comment">        return $nbSP;</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="comment">    }*/</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160; </div>
<div class="line"><a name="l00849"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a8cffd7d3ad956fbd526db6f83b1cadb4">  849</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a8cffd7d3ad956fbd526db6f83b1cadb4">calculateBalanceForProductBefore</a>($productidselected, $datebefore)</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    {</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;        $nb = 0;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160; </div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        $sql = <span class="stringliteral">&#39;SELECT SUM(value) as nb from &#39;</span>.MAIN_DB_PREFIX.<span class="stringliteral">&#39;stock_mouvement&#39;</span>;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        $sql .= <span class="stringliteral">&#39; WHERE fk_product = &#39;</span>.$productidselected;</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        $sql .= <span class="stringliteral">&quot; AND datem &lt; &#39;&quot;</span>.$this-&gt;db-&gt;idate($datebefore).<span class="stringliteral">&quot;&#39;&quot;</span>;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160; </div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).__METHOD__.<span class="stringliteral">&#39;&#39;</span>, LOG_DEBUG);</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        <a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a> = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;query($sql);</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>)</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        {</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;            $obj = $this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>-&gt;fetch_object(<a class="code" href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a>);</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;            <span class="keywordflow">if</span> ($obj) $nb = $obj-&gt;nb;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;            <span class="keywordflow">return</span> (empty($nb) ? 0 : $nb);</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        }</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;        {</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;            <a class="code" href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;        }</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    }</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160; </div>
<div class="line"><a name="l00881"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a645e06fd24262a6e61e3cef62394e8cd">  881</a></span>&#160;    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a645e06fd24262a6e61e3cef62394e8cd">createBatch</a>($dluo, $qty)</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    {</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        global $user;</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160; </div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        $pdluo = <span class="keyword">new</span> <a class="code" href="../../df/d73/class_productbatch.html">Productbatch</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160; </div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        $result = 0;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160; </div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        <span class="comment">// Try to find an existing record with same batch number or id</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        <span class="keywordflow">if</span> (is_numeric($dluo))</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;        {</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;            $result = $pdluo-&gt;fetch($dluo);</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;            <span class="keywordflow">if</span> (empty($pdluo-&gt;id))</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;            {</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                <span class="comment">// We didn&#39;t find the line. May be it was deleted before by a previous move in same transaction.</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                $this-&gt;error = <span class="stringliteral">&#39;Error. You ask a move on a record for a serial that does not exists anymore. May be you take the same serial on same warehouse several times in same shipment or it was used by another shipment. Remove this shipment and prepare another one.&#39;</span>;</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                $this-&gt;errors[] = $this-&gt;error;</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                $result = -2;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;            }</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        }</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;        elseif (is_array($dluo))</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        {</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;            <span class="keywordflow">if</span> (isset($dluo[<span class="stringliteral">&#39;fk_product_stock&#39;</span>]))</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;            {</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                $vfk_product_stock = $dluo[<span class="stringliteral">&#39;fk_product_stock&#39;</span>];</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                $vbatchnumber = $dluo[<span class="stringliteral">&#39;batchnumber&#39;</span>];</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160; </div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                $result = $pdluo-&gt;find($vfk_product_stock, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $vbatchnumber); <span class="comment">// Search on batch number only (eatby and sellby are deprecated here)</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;            }</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;            {</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::createBatch array param dluo must contain at least key fk_product_stock&quot;</span>.$error, LOG_ERR);</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                $result = -1;</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;            }</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        }</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        {</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;            <a class="code" href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a>(get_class($this).<span class="stringliteral">&quot;::createBatch error invalid param dluo&quot;</span>.$error, LOG_ERR);</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;            $result = -1;</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        }</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160; </div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        <span class="keywordflow">if</span> ($result &gt;= 0)</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        {</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;            <span class="comment">// No error</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;            <span class="keywordflow">if</span> ($pdluo-&gt;id &gt; 0)     <span class="comment">// product_batch record found</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;            {</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                <span class="comment">//print &quot;Avant &quot;.$pdluo-&gt;qty.&quot; Apres &quot;.($pdluo-&gt;qty + $qty).&quot;&lt;br&gt;&quot;;</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                $pdluo-&gt;qty += $qty;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                <span class="keywordflow">if</span> ($pdluo-&gt;qty == 0)</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                {</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;                    $result = $pdluo-&gt;delete($user, 1);</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                    $result = $pdluo-&gt;update($user, 1);</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                }</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;            }</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;            <span class="keywordflow">else</span>                    <span class="comment">// product_batch record not found</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;            {</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                $pdluo-&gt;fk_product_stock = $vfk_product_stock;</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                $pdluo-&gt;qty = $qty;</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                $pdluo-&gt;eatby = $veatby;</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;                $pdluo-&gt;sellby = $vsellby;</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;                $pdluo-&gt;batch = $vbatchnumber;</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160; </div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                $result = $pdluo-&gt;create($user, 1);</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;                <span class="keywordflow">if</span> ($result &lt; 0)</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;                {</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;                    $this-&gt;error = $pdluo-&gt;error;</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                    $this-&gt;errors = $pdluo-&gt;errors;</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                }</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;            }</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        }</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160; </div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        <span class="keywordflow">return</span> $result;</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    }</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160; </div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l00964"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a4a7581b15d4d9b05b85adceaaced9aa0">  964</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a4a7581b15d4d9b05b85adceaaced9aa0">get_origin</a>($fk_origin, $origintype)</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    {</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        $origin = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160; </div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        <span class="keywordflow">switch</span> ($origintype) {</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;commande&#39;</span>:</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/commande/class/commande.class.php&#39;</span>;</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                $origin = <span class="keyword">new</span> <a class="code" href="../../da/de7/class_commande.html">Commande</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;shipping&#39;</span>:</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/expedition/class/expedition.class.php&#39;</span>;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                $origin = <span class="keyword">new</span> <a class="code" href="../../de/d38/class_expedition.html">Expedition</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;facture&#39;</span>:</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/compta/facture/class/facture.class.php&#39;</span>;</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                $origin = <span class="keyword">new</span> <a class="code" href="../../d3/d75/class_facture.html">Facture</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;order_supplier&#39;</span>:</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/fourn/class/fournisseur.commande.class.php&#39;</span>;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                $origin = <span class="keyword">new</span> <a class="code" href="../../d7/d70/class_commande_fournisseur.html">CommandeFournisseur</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;invoice_supplier&#39;</span>:</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/fourn/class/fournisseur.facture.class.php&#39;</span>;</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                $origin = <span class="keyword">new</span> <a class="code" href="../../df/d8a/class_facture_fournisseur.html">FactureFournisseur</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;project&#39;</span>:</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/projet/class/project.class.php&#39;</span>;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                $origin = <span class="keyword">new</span> <a class="code" href="../../d9/d6e/class_project.html">Project</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;mo&#39;</span>:</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/mrp/class/mo.class.php&#39;</span>;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                $origin = <span class="keyword">new</span> <a class="code" href="../../d5/dd4/class_mo.html">Mo</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160; </div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;            <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                <span class="keywordflow">if</span> ($origintype)</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                {</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                    <span class="comment">// Separate originetype with &quot;@&quot; : left part is class name, right part is module name</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                    $origintype_array = explode(<span class="charliteral">&#39;@&#39;</span>, $origintype);</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                    $classname = ucfirst($origintype_array[0]);</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                    $modulename = empty($origintype_array[1]) ? $classname : $origintype_array[1];</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                    $result = <a class="code" href="../../d9/d69/functions_8lib_8php.html#a5b2b52738954b2638dc9aa54bf019bd6">dol_include_once</a>(<span class="charliteral">&#39;/&#39;</span>.$modulename.<span class="stringliteral">&#39;/class/&#39;</span>.strtolower($classname).<span class="stringliteral">&#39;.class.php&#39;</span>);</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                    <span class="keywordflow">if</span> ($result)</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                    {</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                        $classname = ucfirst($classname);</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                        $origin = <span class="keyword">new</span> $classname($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                    }</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                }</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        }</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160; </div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        <span class="keywordflow">if</span> (empty($origin) || !is_object($origin)) <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160; </div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        <span class="keywordflow">if</span> ($origin-&gt;fetch($fk_origin) &gt; 0) {</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;            <span class="keywordflow">return</span> $origin-&gt;getNomUrl(1);</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        }</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160; </div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    }</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160; </div>
<div class="line"><a name="l01033"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a2af0ccd5f32a9a626257acbfc2b5e47d"> 1033</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a2af0ccd5f32a9a626257acbfc2b5e47d">setOrigin</a>($origin_element, $origin_id)</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    {</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;        <span class="keywordflow">if</span> (!empty($origin_element) &amp;&amp; $origin_id &gt; 0)</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;        {</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;            $origin = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;            <span class="keywordflow">if</span> ($origin_element == <span class="stringliteral">&#39;project&#39;</span>)</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;            {</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                <span class="keywordflow">if</span> (!class_exists(<span class="stringliteral">&#39;Project&#39;</span>)) require_once DOL_DOCUMENT_ROOT.<span class="stringliteral">&#39;/projet/class/project.class.php&#39;</span>;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                $origin = <span class="keyword">new</span> <a class="code" href="../../d9/d6e/class_project.html">Project</a>($this-&gt;<a class="code" href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a>);</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;            }</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160; </div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;            <span class="keywordflow">if</span> (!empty($origin))</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;            {</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                $this-&gt;origin = $origin;</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                $this-&gt;origin-&gt;id = $origin_id;</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;            }</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        }</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    }</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160; </div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160; </div>
<div class="line"><a name="l01060"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#ad59b22b193826b809f3c36ea6809fa5d"> 1060</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#ad59b22b193826b809f3c36ea6809fa5d">initAsSpecimen</a>()</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    {</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        global $user, $langs, $conf, $mysoc;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160; </div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;        <span class="comment">// Initialize parameters</span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        $this-&gt;<span class="keywordtype">id</span> = 0;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160; </div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        <span class="comment">// There is no specific properties. All data into insert are provided as method parameter.</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    }</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160; </div>
<div class="line"><a name="l01081"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a775702339f1e25634af03eb6debf3caf"> 1081</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a775702339f1e25634af03eb6debf3caf">getNomUrl</a>($withpicto = 0, $option = <span class="stringliteral">&#39;&#39;</span>, $notooltip = 0, $maxlen = 24, $morecss = <span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    {</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;        global $langs, $conf, $db;</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160; </div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        $result = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        $companylink = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160; </div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        $label = <span class="stringliteral">&#39;&lt;u&gt;&#39;</span>.$langs-&gt;trans(<span class="stringliteral">&quot;Movement&quot;</span>).<span class="charliteral">&#39; &#39;</span>.$this-&gt;<span class="keywordtype">id</span>.<span class="stringliteral">&#39;&lt;/u&gt;&#39;</span>;</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;        $label .= <span class="stringliteral">&#39;&lt;div width=&quot;100%&quot;&gt;&#39;</span>;</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        $label .= <span class="stringliteral">&#39;&lt;b&gt;&#39;</span>.$langs-&gt;trans(<span class="stringliteral">&#39;Label&#39;</span>).<span class="stringliteral">&#39;:&lt;/b&gt; &#39;</span>.$this-&gt;label;</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;        $label .= <span class="stringliteral">&#39;&lt;br&gt;&lt;b&gt;&#39;</span>.$langs-&gt;trans(<span class="stringliteral">&#39;Qty&#39;</span>).<span class="stringliteral">&#39;:&lt;/b&gt; &#39;</span>.$this-&gt;qty;</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        $label .= <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160; </div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        $link = <span class="stringliteral">&#39;&lt;a href=&quot;&#39;</span>.DOL_URL_ROOT.<span class="stringliteral">&#39;/product/stock/movement_list.php?id=&#39;</span>.$this-&gt;warehouse_id.<span class="stringliteral">&#39;&amp;msid=&#39;</span>.$this-&gt;<span class="keywordtype">id</span>.<span class="charliteral">&#39;&quot;&#39;</span>;</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        $link .= ($notooltip ? <span class="stringliteral">&#39;&#39;</span> : <span class="stringliteral">&#39; title=&quot;&#39;</span>.dol_escape_htmltag($label, 1).<span class="stringliteral">&#39;&quot; class=&quot;classfortooltip&#39;</span>.($morecss ? <span class="charliteral">&#39; &#39;</span>.$morecss : <span class="stringliteral">&#39;&#39;</span>).<span class="charliteral">&#39;&quot;&#39;</span>);</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        $link .= <span class="charliteral">&#39;&gt;&#39;</span>;</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        $linkend = <span class="stringliteral">&#39;&lt;/a&gt;&#39;</span>;</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160; </div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;        <span class="keywordflow">if</span> ($withpicto)</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        {</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;            $result .= ($link.img_object(($notooltip ? <span class="stringliteral">&#39;&#39;</span> : $label), <span class="stringliteral">&#39;stock&#39;</span>, ($notooltip ? <span class="stringliteral">&#39;&#39;</span> : <span class="stringliteral">&#39;class=&quot;classfortooltip&quot;&#39;</span>)).$linkend);</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;            <span class="keywordflow">if</span> ($withpicto != 2) $result .= <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        }</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;        $result .= $link.$this-&gt;id.$linkend;</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        <span class="keywordflow">return</span> $result;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    }</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160; </div>
<div class="line"><a name="l01114"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a6c49090347eb54ea1a5b3f6750076995"> 1114</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a6c49090347eb54ea1a5b3f6750076995">getLibStatut</a>($mode = 0)</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    {</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        <span class="keywordflow">return</span> $this-&gt;<a class="code" href="../../db/de0/class_mouvement_stock.html#a8a1f678abcb60aa06d0348e8d1271fb7">LibStatut</a>($mode);</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    }</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160; </div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    <span class="comment">// phpcs:disable PEAR.NamingConventions.ValidFunctionName.ScopeNotCamelCaps</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a8a1f678abcb60aa06d0348e8d1271fb7"> 1126</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a8a1f678abcb60aa06d0348e8d1271fb7">LibStatut</a>($mode = 0)</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;    {</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <span class="comment">// phpcs:enable</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        global $langs;</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160; </div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;        <span class="keywordflow">if</span> ($mode == 0 || $mode == 1)</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;        {</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;            <span class="keywordflow">return</span> $langs-&gt;trans(<span class="stringliteral">&#39;StatusNotApplicable&#39;</span>);</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        }</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;        elseif ($mode == 2)</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;        {</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../d9/d69/functions_8lib_8php.html#a64fc44ee4f3329fe0ff256b57bffc128">img_picto</a>($langs-&gt;trans(<span class="stringliteral">&#39;StatusNotApplicable&#39;</span>), <span class="stringliteral">&#39;statut9&#39;</span>).<span class="charliteral">&#39; &#39;</span>.$langs-&gt;trans(<span class="stringliteral">&#39;StatusNotApplicable&#39;</span>);</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        }</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;        elseif ($mode == 3)</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        {</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../d9/d69/functions_8lib_8php.html#a64fc44ee4f3329fe0ff256b57bffc128">img_picto</a>($langs-&gt;trans(<span class="stringliteral">&#39;StatusNotApplicable&#39;</span>), <span class="stringliteral">&#39;statut9&#39;</span>);</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        }</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;        elseif ($mode == 4)</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        {</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../d9/d69/functions_8lib_8php.html#a64fc44ee4f3329fe0ff256b57bffc128">img_picto</a>($langs-&gt;trans(<span class="stringliteral">&#39;StatusNotApplicable&#39;</span>), <span class="stringliteral">&#39;statut9&#39;</span>).<span class="charliteral">&#39; &#39;</span>.$langs-&gt;trans(<span class="stringliteral">&#39;StatusNotApplicable&#39;</span>);</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        }</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        elseif ($mode == 5)</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;        {</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;            <span class="keywordflow">return</span> $langs-&gt;trans(<span class="stringliteral">&#39;StatusNotApplicable&#39;</span>).<span class="charliteral">&#39; &#39;</span>.<a class="code" href="../../d9/d69/functions_8lib_8php.html#a64fc44ee4f3329fe0ff256b57bffc128">img_picto</a>($langs-&gt;trans(<span class="stringliteral">&#39;StatusNotApplicable&#39;</span>), <span class="stringliteral">&#39;statut9&#39;</span>);</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;        }</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    }</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160; </div>
<div class="line"><a name="l01163"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a9059dd9f83a50655a9d7e8be73ef6999"> 1163</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="../../db/de0/class_mouvement_stock.html#a9059dd9f83a50655a9d7e8be73ef6999">generateDocument</a>($modele, $outputlangs = <span class="stringliteral">&#39;&#39;</span>, $hidedetails = 0, $hidedesc = 0, $hideref = 0)</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    {</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;        global $conf, $user, $langs;</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160; </div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;        $langs-&gt;load(<span class="stringliteral">&quot;stocks&quot;</span>);</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;        $outputlangs-&gt;load(<span class="stringliteral">&quot;products&quot;</span>);</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160; </div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d69/functions_8lib_8php.html#a4df903ca7651cb97e1076e3716a30c38">dol_strlen</a>($modele)) {</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;            $modele = <span class="stringliteral">&#39;stdmovement&#39;</span>;</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160; </div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;            <span class="keywordflow">if</span> ($this-&gt;modelpdf) {</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;                $modele = $this-&gt;modelpdf;</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;            } elseif (!empty($conf-&gt;global-&gt;MOUVEMENT_ADDON_PDF)) {</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;                $modele = $conf-&gt;global-&gt;MOUVEMENT_ADDON_PDF;</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;            }</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;        }</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160; </div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;        $modelpath = <span class="stringliteral">&quot;core/modules/stock/doc/&quot;</span>;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160; </div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        <span class="keywordflow">return</span> $this-&gt;<a class="code" href="../../db/d09/class_common_object.html#a5e4c7fde30b94ba9fb38e9678cb2d3cf">commonGenerateDocument</a>($modelpath, $modele, $outputlangs, $hidedetails, $hidedesc, $hideref);</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    }</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160; </div>
<div class="line"><a name="l01192"></a><span class="lineno"><a class="line" href="../../db/de0/class_mouvement_stock.html#a472ab29daa683f2356f6e1ac38ce3830"> 1192</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">function</span> <span class="keyword">delete</span>(<a class="code" href="../../d7/d23/class_user.html">User</a> $user, $notrigger = <span class="keyword">false</span>)</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    {</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        <span class="keywordflow">return</span> $this-&gt;<a class="code" href="../../db/d09/class_common_object.html#ac946ac358d5f68e9c5a134d5795100f1">deleteCommon</a>($user, $notrigger);</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        <span class="comment">//return $this-&gt;deleteCommon($user, $notrigger, 1);</span></div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    }</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="aclass_productbatch_html"><div class="ttname"><a href="../../df/d73/class_productbatch.html">Productbatch</a></div><div class="ttdoc">Manage record for batch number management.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d51/productbatch_8class_8php_source.html#l00031">productbatch.class.php:31</a></div></div>
<div class="ttc" id="aclass_expedition_html"><div class="ttname"><a href="../../de/d38/class_expedition.html">Expedition</a></div><div class="ttdoc">Class to manage shipments.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ded/expedition_8class_8php_source.html#l00047">expedition.class.php:47</a></div></div>
<div class="ttc" id="aclass_project_html"><div class="ttname"><a href="../../d9/d6e/class_project.html">Project</a></div><div class="ttdoc">Class to manage projects.</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/project_8class_8php_source.html#l00034">project.class.php:34</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a9059dd9f83a50655a9d7e8be73ef6999"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a9059dd9f83a50655a9d7e8be73ef6999">MouvementStock\generateDocument</a></div><div class="ttdeci">generateDocument($modele, $outputlangs='', $hidedetails=0, $hidedesc=0, $hideref=0)</div><div class="ttdoc">Create object on disk.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l01163">mouvementstock.class.php:1163</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_ad59b22b193826b809f3c36ea6809fa5d"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#ad59b22b193826b809f3c36ea6809fa5d">MouvementStock\initAsSpecimen</a></div><div class="ttdeci">initAsSpecimen()</div><div class="ttdoc">Initialise an instance with random values.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l01060">mouvementstock.class.php:1060</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a800f8efee13692788b13ee57c5960092"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a800f8efee13692788b13ee57c5960092">MouvementStock\__construct</a></div><div class="ttdeci">__construct($db)</div><div class="ttdoc">Constructor.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00114">mouvementstock.class.php:114</a></div></div>
<div class="ttc" id="aclass_facture_fournisseur_html"><div class="ttname"><a href="../../df/d8a/class_facture_fournisseur.html">FactureFournisseur</a></div><div class="ttdoc">Class to manage suppliers invoices.</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/df0/fournisseur_8facture_8class_8php_source.html#l00044">fournisseur.facture.class.php:44</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a39a0441491a380f7f9fe07ee296cd2fa"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a39a0441491a380f7f9fe07ee296cd2fa">dol_print_error</a></div><div class="ttdeci">dol_print_error($db='', $error='', $errors=null)</div><div class="ttdoc">Displays error message system with all the information to facilitate the diagnosis and the escalation...</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l03964">functions.lib.php:3964</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a5b2b52738954b2638dc9aa54bf019bd6"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a5b2b52738954b2638dc9aa54bf019bd6">dol_include_once</a></div><div class="ttdeci">if(!function_exists('dol_getprefix')) dol_include_once($relpath, $classname='')</div><div class="ttdoc">Make an include_once using default root and alternate root if it fails.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l00716">functions.lib.php:716</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_ac190600157fb61d00e255bc50f2c9711"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#ac190600157fb61d00e255bc50f2c9711">MouvementStock\reception</a></div><div class="ttdeci">reception($user, $fk_product, $entrepot_id, $qty, $price=0, $label='', $eatby='', $sellby='', $batch='', $datem='', $id_product_batch=0, $inventorycode='')</div><div class="ttdoc">Increase stock for product and subproducts.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00810">mouvementstock.class.php:810</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a53f251224139972d5a82e9eee507f4f7"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a53f251224139972d5a82e9eee507f4f7">MouvementStock\_createSubProduct</a></div><div class="ttdeci">_createSubProduct($user, $idProduct, $entrepot_id, $qty, $type, $price=0, $label='', $inventorycode='')</div><div class="ttdoc">Create movement in database for all subproducts.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00711">mouvementstock.class.php:711</a></div></div>
<div class="ttc" id="aclass_common_object_html_ac946ac358d5f68e9c5a134d5795100f1"><div class="ttname"><a href="../../db/d09/class_common_object.html#ac946ac358d5f68e9c5a134d5795100f1">CommonObject\deleteCommon</a></div><div class="ttdeci">deleteCommon(User $user, $notrigger=false, $forcechilddeletion=0)</div><div class="ttdoc">Delete object in database.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d24/commonobject_8class_8php_source.html#l08303">commonobject.class.php:8303</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a7bb2f80ee033060c3f3be6a8d7cc9c84"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a7bb2f80ee033060c3f3be6a8d7cc9c84">dol_mktime</a></div><div class="ttdeci">dol_mktime($hour, $minute, $second, $month, $day, $year, $gm=false, $check=1)</div><div class="ttdoc">Return a timestamp date built from detailed informations (by default a local PHP server timestamp) Re...</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l02090">functions.lib.php:2090</a></div></div>
<div class="ttc" id="aclass_facture_html"><div class="ttname"><a href="../../d3/d75/class_facture.html">Facture</a></div><div class="ttdoc">Class to manage invoices.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/ddc/facture_8class_8php_source.html#l00054">facture.class.php:54</a></div></div>
<div class="ttc" id="aclass_mo_html"><div class="ttname"><a href="../../d5/dd4/class_mo.html">Mo</a></div><div class="ttdoc">Class for Mo.</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d31/mo_8class_8php_source.html#l00034">mo.class.php:34</a></div></div>
<div class="ttc" id="aclass_common_object_html"><div class="ttname"><a href="../../db/d09/class_common_object.html">CommonObject</a></div><div class="ttdoc">Parent class of all other business classes (invoices, contracts, proposals, orders,...</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d24/commonobject_8class_8php_source.html#l00042">commonobject.class.php:42</a></div></div>
<div class="ttc" id="arepair_8php_html_aeb426eab229a79c49626c27a34ea0a90"><div class="ttname"><a href="../../d1/d2d/repair_8php.html#aeb426eab229a79c49626c27a34ea0a90">type</a></div><div class="ttdeci">if(preg_match('/crypted:/i', $dolibarr_main_db_pass)||!empty($dolibarr_main_db_encrypted_pass)) $conf db type</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d2d/repair_8php_source.html#l00107">repair.php:107</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a34644574d03047e0104710288a28ac91"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a34644574d03047e0104710288a28ac91">price2num</a></div><div class="ttdeci">price2num($amount, $rounding='', $option=0)</div><div class="ttdoc">Function that return a number with universal decimal format (decimal separator is '.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l04734">functions.lib.php:4734</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a6c49090347eb54ea1a5b3f6750076995"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a6c49090347eb54ea1a5b3f6750076995">MouvementStock\getLibStatut</a></div><div class="ttdeci">getLibStatut($mode=0)</div><div class="ttdoc">Return label statut.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l01114">mouvementstock.class.php:1114</a></div></div>
<div class="ttc" id="aclass_productlot_html"><div class="ttname"><a href="../../d1/d07/class_productlot.html">Productlot</a></div><div class="ttdoc">Class with list of lots and properties.</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d12/productlot_8class_8php_source.html#l00036">productlot.class.php:36</a></div></div>
<div class="ttc" id="aclass_common_object_html_ad0433842f96f49b6d04192a728161ec8"><div class="ttname"><a href="../../db/d09/class_common_object.html#ad0433842f96f49b6d04192a728161ec8">CommonObject\fetch_optionals</a></div><div class="ttdeci">fetch_optionals($rowid=null, $optionsArray=null)</div><div class="ttdoc">Function to get extra fields of an object into $this-&gt;array_options This method is in most cases call...</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d24/commonobject_8class_8php_source.html#l05311">commonobject.class.php:5311</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a64fc44ee4f3329fe0ff256b57bffc128"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a64fc44ee4f3329fe0ff256b57bffc128">img_picto</a></div><div class="ttdeci">img_picto($titlealt, $picto, $moreatt='', $pictoisfullpath=false, $srconly=0, $notitle=0, $alt='', $morecss='', $marginleftonlyshort=2)</div><div class="ttdoc">Show picto whatever it's its name (generic function)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l03152">functions.lib.php:3152</a></div></div>
<div class="ttc" id="acompta_2index_8php_html_a963feeaed7a25f42dc7c8e6966fcbc3f"><div class="ttname"><a href="../../d9/d3c/compta_2index_8php.html#a963feeaed7a25f42dc7c8e6966fcbc3f">$resql</a></div><div class="ttdeci">if(!empty($conf-&gt;facture-&gt;enabled) &amp;&amp; $user-&gt;rights-&gt;facture-&gt;lire) if((!empty($conf-&gt;fournisseur-&gt;enabled) &amp;&amp;empty($conf-&gt;global-&gt;MAIN_USE_NEW_SUPPLIERMOD)||!empty($conf-&gt;supplier_invoice-&gt;enabled)) &amp;&amp; $user-&gt;rights-&gt;fournisseur-&gt;facture-&gt;lire) if(!empty($conf-&gt;don-&gt;enabled) &amp;&amp; $user-&gt;rights-&gt;don-&gt;lire) if(!empty($conf-&gt;tax-&gt;enabled) &amp;&amp; $user-&gt;rights-&gt;tax-&gt;charges-&gt;lire) if(!empty($conf-&gt;facture-&gt;enabled) &amp;&amp;!empty($conf-&gt;commande-&gt;enabled) &amp;&amp; $user-&gt;rights-&gt;commande-&gt;lire &amp;&amp;empty($conf-&gt;global-&gt;WORKFLOW_DISABLE_CREATE_INVOICE_FROM_ORDER)) if(!empty($conf-&gt;facture-&gt;enabled) &amp;&amp; $user-&gt;rights-&gt;facture-&gt;lire) if((!empty($conf-&gt;fournisseur-&gt;enabled) &amp;&amp;empty($conf-&gt;global-&gt;MAIN_USE_NEW_SUPPLIERMOD)||!empty($conf-&gt;supplier_invoice-&gt;enabled)) &amp;&amp; $user-&gt;rights-&gt;fournisseur-&gt;facture-&gt;lire) $resql</div><div class="ttdoc">Social contributions to pay.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d3c/compta_2index_8php_source.html#l01078">index.php:1078</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_aca60d7c39a5e48edd6ff6ee153a803a2"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#aca60d7c39a5e48edd6ff6ee153a803a2">MouvementStock\fetch</a></div><div class="ttdeci">fetch($id)</div><div class="ttdoc">Load object in memory from the database.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00617">mouvementstock.class.php:617</a></div></div>
<div class="ttc" id="aclass_common_object_html_a5e4c7fde30b94ba9fb38e9678cb2d3cf"><div class="ttname"><a href="../../db/d09/class_common_object.html#a5e4c7fde30b94ba9fb38e9678cb2d3cf">CommonObject\commonGenerateDocument</a></div><div class="ttdeci">commonGenerateDocument($modelspath, $modele, $outputlangs, $hidedetails, $hidedesc, $hideref, $moreparams=null)</div><div class="ttdoc">Common function for all objects extending CommonObject for generating documents.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d24/commonobject_8class_8php_source.html#l04747">commonobject.class.php:4747</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a645e06fd24262a6e61e3cef62394e8cd"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a645e06fd24262a6e61e3cef62394e8cd">MouvementStock\createBatch</a></div><div class="ttdeci">createBatch($dluo, $qty)</div><div class="ttdoc">Create or update batch record (update table llx_product_batch).</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00881">mouvementstock.class.php:881</a></div></div>
<div class="ttc" id="aclass_common_object_html_a75b0f5e3db34fedda4338c344ef626ab"><div class="ttname"><a href="../../db/d09/class_common_object.html#a75b0f5e3db34fedda4338c344ef626ab">CommonObject\call_trigger</a></div><div class="ttdeci">call_trigger($triggerName, $user)</div><div class="ttdoc">Call trigger based on this instance.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d24/commonobject_8class_8php_source.html#l05092">commonobject.class.php:5092</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html">MouvementStock</a></div><div class="ttdoc">Class to manage stock movements.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00031">mouvementstock.class.php:31</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a8a1f678abcb60aa06d0348e8d1271fb7"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a8a1f678abcb60aa06d0348e8d1271fb7">MouvementStock\LibStatut</a></div><div class="ttdeci">LibStatut($mode=0)</div><div class="ttdoc">Renvoi le libelle d'un status donne.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l01126">mouvementstock.class.php:1126</a></div></div>
<div class="ttc" id="aclass_commande_html"><div class="ttname"><a href="../../da/de7/class_commande.html">Commande</a></div><div class="ttdoc">Class to manage customers orders.</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df5/commande_8class_8php_source.html#l00043">commande.class.php:43</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a8cffd7d3ad956fbd526db6f83b1cadb4"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a8cffd7d3ad956fbd526db6f83b1cadb4">MouvementStock\calculateBalanceForProductBefore</a></div><div class="ttdeci">calculateBalanceForProductBefore($productidselected, $datebefore)</div><div class="ttdoc">Return nb of subproducts lines for a product.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00849">mouvementstock.class.php:849</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_af601a73af63cca748b9a57e810259372"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#af601a73af63cca748b9a57e810259372">dol_syslog</a></div><div class="ttdeci">dol_syslog($message, $level=LOG_INFO, $ident=0, $suffixinfilename='', $restricttologhandler='', $logcontext=null)</div><div class="ttdoc">Write log message into outputs.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l01099">functions.lib.php:1099</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a0144f55739ee9aeae74eeb8796a6f498"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a0144f55739ee9aeae74eeb8796a6f498">dol_now</a></div><div class="ttdeci">dol_now($mode='gmt')</div><div class="ttdoc">Return date for now.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l02165">functions.lib.php:2165</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a4a7581b15d4d9b05b85adceaaced9aa0"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a4a7581b15d4d9b05b85adceaaced9aa0">MouvementStock\get_origin</a></div><div class="ttdeci">get_origin($fk_origin, $origintype)</div><div class="ttdoc">Return Url link of origin object.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00964">mouvementstock.class.php:964</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a2f944c8af5b43fbd1983d0635ba05fc8"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a2f944c8af5b43fbd1983d0635ba05fc8">MouvementStock\livraison</a></div><div class="ttdeci">livraison($user, $fk_product, $entrepot_id, $qty, $price=0, $label='', $datem='', $eatby='', $sellby='', $batch='', $id_product_batch=0, $inventorycode='')</div><div class="ttdoc">Decrease stock for product and subproducts.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00784">mouvementstock.class.php:784</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a4df903ca7651cb97e1076e3716a30c38"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a4df903ca7651cb97e1076e3716a30c38">dol_strlen</a></div><div class="ttdeci">dol_strlen($string, $stringencoding='UTF-8')</div><div class="ttdoc">Make a strlen call.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l03020">functions.lib.php:3020</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a4b0bf353474b7753614df9d97714bb46"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a4b0bf353474b7753614df9d97714bb46">dol_print_date</a></div><div class="ttdeci">dol_print_date($time, $format='', $tzoutput='tzserver', $outputlangs='', $encodetooutput=false)</div><div class="ttdoc">Output date in a string format according to outputlangs (or langs if not defined).</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l01868">functions.lib.php:1868</a></div></div>
<div class="ttc" id="aclass_commande_fournisseur_html"><div class="ttname"><a href="../../d7/d70/class_commande_fournisseur.html">CommandeFournisseur</a></div><div class="ttdoc">Class to manage predefined suppliers products.</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d60/fournisseur_8commande_8class_8php_source.html#l00043">fournisseur.commande.class.php:43</a></div></div>
<div class="ttc" id="aclass_user_html"><div class="ttname"><a href="../../d7/d23/class_user.html">User</a></div><div class="ttdoc">Class to manage Dolibarr users.</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/da1/user_8class_8php_source.html#l00044">user.class.php:44</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a2af0ccd5f32a9a626257acbfc2b5e47d"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a2af0ccd5f32a9a626257acbfc2b5e47d">MouvementStock\setOrigin</a></div><div class="ttdeci">setOrigin($origin_element, $origin_id)</div><div class="ttdoc">Set attribute origin to object.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l01033">mouvementstock.class.php:1033</a></div></div>
<div class="ttc" id="aclass_product_html"><div class="ttname"><a href="../../dc/d42/class_product.html">Product</a></div><div class="ttdoc">Class to manage products or services.</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/dab/product_8class_8php_source.html#l00045">product.class.php:45</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_ac8e88a1be83e6a946c6645cb92adc4c8"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#ac8e88a1be83e6a946c6645cb92adc4c8">MouvementStock\_create</a></div><div class="ttdeci">_create($user, $fk_product, $entrepot_id, $qty, $type, $price=0, $label='', $inventorycode='', $datem='', $eatby='', $sellby='', $batch='', $skip_batch=false, $id_product_batch=0)</div><div class="ttdoc">Add a movement of stock (in one direction only).</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l00143">mouvementstock.class.php:143</a></div></div>
<div class="ttc" id="aclass_product_html_a8243368e8df7d3bb04055b5f083aab48"><div class="ttname"><a href="../../dc/d42/class_product.html#a8243368e8df7d3bb04055b5f083aab48">Product\TYPE_SERVICE</a></div><div class="ttdeci">const TYPE_SERVICE</div><div class="ttdoc">Service.</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/dab/product_8class_8php_source.html#l00417">product.class.php:417</a></div></div>
<div class="ttc" id="ainstall_2inc_8php_html_ac5c9be6a1c1e82d353381986a8e859b6"><div class="ttname"><a href="../../d0/d79/install_2inc_8php.html#ac5c9be6a1c1e82d353381986a8e859b6">db</a></div><div class="ttdeci">$conf db</div><div class="ttdoc">API class for accounts.</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d79/install_2inc_8php_source.html#l00054">inc.php:54</a></div></div>
<div class="ttc" id="aclass_entrepot_html"><div class="ttname"><a href="../../db/de4/class_entrepot.html">Entrepot</a></div><div class="ttdoc">Class to manage warehouses.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/dbe/entrepot_8class_8php_source.html#l00035">entrepot.class.php:35</a></div></div>
<div class="ttc" id="aclass_mouvement_stock_html_a775702339f1e25634af03eb6debf3caf"><div class="ttname"><a href="../../db/de0/class_mouvement_stock.html#a775702339f1e25634af03eb6debf3caf">MouvementStock\getNomUrl</a></div><div class="ttdeci">getNomUrl($withpicto=0, $option='', $notooltip=0, $maxlen=24, $morecss='')</div><div class="ttdoc">Return a link (with optionaly the picto) Use this-&gt;id,this-&gt;lastname, this-&gt;firstname.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d47/mouvementstock_8class_8php_source.html#l01081">mouvementstock.class.php:1081</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a4f4158875f7336eb9999442262e48eee"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a4f4158875f7336eb9999442262e48eee">price</a></div><div class="ttdeci">price($amount, $form=0, $outlangs='', $trunc=1, $rounding=-1, $forcerounding=-1, $currency_code='')</div><div class="ttdoc">Function to format a value into an amount for visual output Function used into PDF and HTML pages.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l04637">functions.lib.php:4637</a></div></div>
<div class="ttc" id="afunctions_8lib_8php_html_a0c15a8be3998272a30daa20a5a7c0ab2"><div class="ttname"><a href="../../d9/d69/functions_8lib_8php.html#a0c15a8be3998272a30daa20a5a7c0ab2">dol_getdate</a></div><div class="ttdeci">dol_getdate($timestamp, $fast=false)</div><div class="ttdoc">Return an array with locale date info.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d69/functions_8lib_8php_source.html#l02051">functions.lib.php:2051</a></div></div>
<!-- 
File added into doxygen generated documentation
-->
<hr class="footer" />
<address class="footer"><small>Generated on Tue Oct 19 2021 23:11:08 for <a href="https://www.dolibarr.org" title="ERP and CRM open source software">Dolibarr</a> by Doxygen 1.8.17 </small></address>
<br>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-9049390-16"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-9049390-16');
</script>
</body>
</html>